<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <?!= include('design-tokens') ?>
  <style>
  <?!= include('settings-styles') ?>
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loading" class="loading-overlay">
    <div class="spinner" role="status" aria-label="Loading settings"></div>
    <div class="loading-text">Loading your settings...</div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container" role="alert" aria-live="polite"></div>

  <div class="modal-overlay" id="confirmDialog" role="alertdialog" aria-modal="true" aria-labelledby="confirmDialogTitle">
    <div class="modal confirm-modal">
      <div class="modal-header">
        <h3 class="modal-title" id="confirmDialogTitle"></h3>
      </div>
      <div class="modal-body">
        <p id="confirmDialogMessage"></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="confirmDialogCancel">Cancel</button>
        <button class="btn btn-primary" id="confirmDialogConfirm">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Onboarding Wizard Overlay -->
  <div id="wizardOverlay" class="wizard-overlay hidden">
    <div class="wizard-container">
      <div class="wizard-header">
        <div class="wizard-header-content">
          <h1 class="wizard-title">Welcome to Billing Setup!</h1>
          <p class="wizard-subtitle">Let's get your billing system ready in just a few steps</p>
          <div class="wizard-progress">
            <div class="wizard-progress-bar">
              <div id="wizardProgressFill" class="wizard-progress-fill" style="width: 25%"></div>
            </div>
            <div class="wizard-steps">
              <div class="wizard-step active" data-step="1">
                <div class="wizard-step-dot"></div>
                <span class="wizard-step-label">Twilio</span>
              </div>
              <div class="wizard-step" data-step="2">
                <div class="wizard-step-dot"></div>
                <span class="wizard-step-label">Business</span>
              </div>
              <div class="wizard-step" data-step="3">
                <div class="wizard-step-dot"></div>
                <span class="wizard-step-label">Columns</span>
              </div>
              <div class="wizard-step" data-step="4">
                <div class="wizard-step-dot"></div>
                <span class="wizard-step-label">Finish</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="wizard-body">
        <!-- Step 1: Twilio Credentials -->
        <div id="wizardStep1" class="wizard-panel active">
          <h2 class="wizard-section-title">Connect to Twilio</h2>
          <p class="wizard-section-desc">Twilio is the service that sends text messages to your customers. You'll need to create a free account at <a href="https://www.twilio.com/try-twilio" target="_blank" style="color: var(--color-primary);">twilio.com</a> to get your credentials.</p>

          <div class="form-group">
            <label class="form-label" for="wizardAccountSid">Account SID</label>
            <p class="form-hint">Found on your Twilio Console dashboard (starts with "AC")</p>
            <input type="text" class="form-input" id="wizardAccountSid" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" autocomplete="off">
            <div id="wizardAccountSidValidation" class="field-validation hidden"></div>
          </div>

          <div class="form-group">
            <label class="form-label" for="wizardAuthToken">Auth Token</label>
            <p class="form-hint">Click "Show" on your Twilio Console to reveal this secret token</p>
            <input type="password" class="form-input" id="wizardAuthToken" placeholder="Your auth token" autocomplete="off">
            <div id="wizardAuthTokenValidation" class="field-validation hidden"></div>
          </div>

          <div class="form-group">
            <label class="form-label" for="wizardTwilioPhone">Twilio Phone Number</label>
            <p class="form-hint">The phone number you purchased from Twilio (format: +1XXXXXXXXXX)</p>
            <input type="tel" class="form-input" id="wizardTwilioPhone" placeholder="+1 (555) 123-4567" autocomplete="off">
            <div id="wizardTwilioPhoneValidation" class="field-validation hidden"></div>
          </div>

          <div id="wizardCredentialStatus" class="credential-test-status idle">
            <svg class="credential-test-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            <div class="credential-test-content">
              <div class="credential-test-title">Ready to Test</div>
              <div class="credential-test-message">Fill in your credentials above, then click "Test Connection"</div>
            </div>
          </div>
        </div>

        <!-- Step 2: Business Info -->
        <div id="wizardStep2" class="wizard-panel">
          <h2 class="wizard-section-title">Your Business Details</h2>
          <p class="wizard-section-desc">This information appears in the text messages sent to your customers. Make sure it's accurate!</p>

          <div class="form-group">
            <label class="form-label" for="wizardBusinessName">Business Name</label>
            <p class="form-hint">The name customers will see in messages</p>
            <input type="text" class="form-input" id="wizardBusinessName" placeholder="e.g., Ilaxi's Gujarati Tiffin" maxlength="100">
            <div id="wizardBusinessNameValidation" class="field-validation hidden"></div>
          </div>

          <div class="form-group">
            <label class="form-label" for="wizardEtransferEmail">Email for Receiving Payments</label>
            <p class="form-hint">Where customers send Interac e-Transfer payments</p>
            <input type="email" class="form-input" id="wizardEtransferEmail" placeholder="payments@mybusiness.com">
            <div id="wizardEtransferEmailValidation" class="field-validation hidden"></div>
          </div>

          <div class="form-group">
            <label class="form-label" for="wizardPhoneNumber">Your Phone Number</label>
            <p class="form-hint">Customers can call or text this number with questions</p>
            <input type="tel" class="form-input" id="wizardPhoneNumber" placeholder="+1 (416) 555-1234" maxlength="20">
            <div id="wizardPhoneNumberValidation" class="field-validation hidden"></div>
          </div>

          <div class="form-group">
            <label class="form-label" for="wizardWhatsappLink">
              WhatsApp Link
              <span class="optional">(optional)</span>
            </label>
            <p class="form-hint">If you use WhatsApp, customers can send payment screenshots here</p>
            <input type="url" class="form-input" id="wizardWhatsappLink" placeholder="https://wa.me/14165551234">
          </div>
        </div>

        <!-- Step 3: Column Mapping -->
        <div id="wizardStep3" class="wizard-panel">
          <h2 class="wizard-section-title">Connect Your Spreadsheet</h2>
          <p class="wizard-section-desc">We'll try to automatically detect which columns in your spreadsheet contain which information. Review and adjust if needed.</p>

          <div id="wizardColumnStatus" class="credential-test-status idle" style="margin-bottom: var(--space-4); margin-top: 0;">
            <div class="credential-test-spinner"></div>
            <div class="credential-test-content">
              <div class="credential-test-title">Analyzing Your Spreadsheet...</div>
              <div class="credential-test-message">Looking for column headers</div>
            </div>
          </div>

          <div id="wizardColumnsContainer">
            <!-- Will be populated by JavaScript -->
          </div>

          <div id="wizardColumnsEmpty" class="empty-state hidden">
            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="3" y1="9" x2="21" y2="9"></line>
              <line x1="9" y1="21" x2="9" y2="9"></line>
            </svg>
            <h3>No Columns Found</h3>
            <p>Make sure your spreadsheet has a header row with column names like "Customer Name", "Phone Number", etc.</p>
            <button type="button" class="btn btn-secondary" onclick="wizardRefreshColumns()">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
              Refresh Column List
            </button>
          </div>
        </div>

        <!-- Step 4: Confirmation -->
        <div id="wizardStep4" class="wizard-panel">
          <h2 class="wizard-section-title">You're All Set!</h2>
          <p class="wizard-section-desc">Here's a summary of your setup. You can always change these settings later.</p>

          <div class="summary-card">
            <div class="summary-card-title">Twilio Connection</div>
            <div class="summary-card-content">
              <div class="summary-item">
                <span class="summary-label">Status</span>
                <span id="wizardSummaryTwilioStatus" class="summary-value success">Connected</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Phone Number</span>
                <span id="wizardSummaryTwilioPhone" class="summary-value">+1 (555) 123-4567</span>
              </div>
            </div>
          </div>

          <div class="summary-card">
            <div class="summary-card-title">Business Info</div>
            <div class="summary-card-content">
              <div class="summary-item">
                <span class="summary-label">Name</span>
                <span id="wizardSummaryBusinessName" class="summary-value">Your Business</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Payment Email</span>
                <span id="wizardSummaryEmail" class="summary-value">email@example.com</span>
              </div>
            </div>
          </div>

          <div class="summary-card">
            <div class="summary-card-title">Spreadsheet Columns</div>
            <div id="wizardSummaryColumns" class="summary-card-content">
              <!-- Populated by JavaScript -->
            </div>
          </div>

          <div class="tip-box" style="margin-top: var(--space-4);">
            <svg class="tip-box-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
            <span><strong>Tip:</strong> When sending bills, you'll be asked to choose Test Mode or Real Mode each time, so you can safely practice first.</span>
          </div>
        </div>
      </div>

      <div class="wizard-footer">
        <div class="wizard-footer-left">
          <button type="button" class="btn btn-ghost" id="wizardSkipBtn" onclick="skipWizard()">
            Skip for Now
          </button>
        </div>
        <div class="wizard-footer-right">
          <button type="button" class="btn btn-secondary" id="wizardBackBtn" onclick="wizardBack()" style="display: none;">
            Back
          </button>
          <button type="button" class="btn btn-secondary" id="wizardTestBtn" onclick="wizardTestCredentials()">
            Test Connection
          </button>
          <button type="button" class="btn btn-primary" id="wizardNextBtn" onclick="wizardNext()">
            Next Step
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: 4px;">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <h1>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
        Settings
      </h1>
      <p class="header-subtitle">Customize your billing messages and preferences</p>
      <div id="unsavedBadge" class="unsaved-badge">
        You have unsaved changes
      </div>
    </div>
  </header>

  <!-- Tab Navigation -->
  <nav class="tabs" role="tablist" aria-label="Settings sections">
    <button class="tab active" data-tab="business" role="tab" aria-selected="true" aria-controls="panel-business">
      <span class="tab-number">1</span>
      <span>Your Business</span>
    </button>
    <button class="tab" data-tab="templates" role="tab" aria-selected="false" aria-controls="panel-templates">
      <span class="tab-number">2</span>
      <span>Messages</span>
    </button>
    <button class="tab" data-tab="behavior" role="tab" aria-selected="false" aria-controls="panel-behavior">
      <span class="tab-number">3</span>
      <span>Options</span>
    </button>
    <button class="tab" data-tab="columns" role="tab" aria-selected="false" aria-controls="panel-columns">
      <span class="tab-number">4</span>
      <span>Spreadsheet</span>
    </button>
  </nav>

  <!-- Content Area -->
  <main class="content">
    <!-- Business Tab -->
    <section id="panel-business" class="tab-panel active" role="tabpanel" aria-labelledby="tab-business">
      <div class="info-box">
        <svg class="info-box-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <div class="info-box-content">
          <div class="info-box-title">Your Business Details</div>
          <div class="info-box-text">Fill in your business details below. This information appears in every billing message sent to your customers, so they know who the message is from and how to pay.</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
          </svg>
          <div class="card-header-text">
            <h2 class="card-title">Business Details</h2>
            <p class="card-subtitle">Your business name and contact information</p>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label" for="businessName">Business Name</label>
            <p class="form-hint">The name customers will see in messages</p>
            <input type="text" class="form-input" id="businessName" maxlength="100" placeholder="e.g., Ilaxi's Gujarati Tiffin" autocomplete="organization">
          </div>

          <div class="form-group">
            <label class="form-label" for="phoneNumber">Your Phone Number</label>
            <p class="form-hint">Customers can call or text this number with questions</p>
            <input type="tel" class="form-input" id="phoneNumber" maxlength="20" placeholder="e.g., +1 (416) 555-1234" autocomplete="tel">
          </div>

          <div class="form-group">
            <label class="form-label" for="etransferEmail">Email for Receiving Payments</label>
            <p class="form-hint">Where customers send Interac e-Transfer payments</p>
            <input type="email" class="form-input" id="etransferEmail" placeholder="e.g., payments@mybusiness.com" autocomplete="email">
          </div>

          <div class="form-group">
            <label class="form-label" for="whatsappLink">
              WhatsApp Link
              <span class="optional">(optional)</span>
            </label>
            <p class="form-hint">If you use WhatsApp, customers can send payment screenshots here</p>
            <input type="url" class="form-input" id="whatsappLink" placeholder="e.g., https://wa.me/14165551234">
          </div>
        </div>

        <div class="tip-box">
          <svg class="tip-box-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
          </svg>
          <span><strong>Tip:</strong> Double-check your payment email! Customers will send money to this address.</span>
        </div>
      </div>

    </section>

    <!-- Templates Tab -->
    <section id="panel-templates" class="tab-panel" role="tabpanel" aria-labelledby="tab-templates">
      <div class="info-box">
        <svg class="info-box-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <div class="info-box-content">
          <div class="info-box-title">Customize Your Messages</div>
          <div class="info-box-text">Customize the messages sent at each stage of your billing cycle. Click a tab below to edit each template, and use the blue placeholder buttons to insert customer data like name, balance, and due date.</div>
        </div>
      </div>

      <!-- Bill Messages Card with Sub-tabs -->
      <div class="card">
        <div class="card-header">
          <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="12" y1="18" x2="12" y2="12"></line>
            <line x1="9" y1="15" x2="15" y2="15"></line>
          </svg>
          <div class="card-header-text">
            <h2 class="card-title">Payment Request Messages</h2>
            <p class="card-subtitle">Different messages for different situations</p>
          </div>
        </div>

        <p class="form-hint" style="margin-bottom: var(--space-3);">You have 3 types of payment request messages. Use <strong>First Notice</strong> for new bills, <strong>Follow-up</strong> for reminders, and <strong>Final Notice</strong> for overdue payments.</p>

        <!-- Template Type Selector -->
        <div class="template-tabs" role="tablist">
          <button type="button" class="template-tab active" data-template="firstNotice" role="tab" aria-selected="true">
            <span class="template-tab-number">1</span>
            <span class="template-tab-label">First Notice</span>
          </button>
          <button type="button" class="template-tab" data-template="followUp" role="tab" aria-selected="false">
            <span class="template-tab-number">2</span>
            <span class="template-tab-label">Follow-up</span>
          </button>
          <button type="button" class="template-tab" data-template="finalNotice" role="tab" aria-selected="false">
            <span class="template-tab-number">3</span>
            <span class="template-tab-label">Final Notice</span>
          </button>
        </div>

        <!-- First Notice Template -->
        <div id="template-firstNotice" class="template-panel active" role="tabpanel">
          <div class="form-group">
            <label class="form-label" for="firstNoticeName">Message Name</label>
            <p class="form-hint">A short name to identify this message type</p>
            <input type="text" class="form-input" id="firstNoticeName" maxlength="50" placeholder="e.g., First Notice">
          </div>

          <div class="placeholder-section">
            <div class="placeholder-label">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5"></path>
                <path d="M2 12l10 5 10-5"></path>
              </svg>
              Click to insert customer information:
            </div>
            <div class="placeholder-chips" data-target="firstNoticeMessage">
              <button type="button" class="chip" data-placeholder="{{customerName}}" title="The customer's name">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                Customer's Name
              </button>
              <button type="button" class="chip" data-placeholder="{{balance}}" title="Amount they owe">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                Amount Owed
              </button>
              <button type="button" class="chip" data-placeholder="{{numTiffins}}" title="Number of tiffins">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                Number of Tiffins
              </button>
              <button type="button" class="chip" data-placeholder="{{month}}" title="Billing month">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                Month
              </button>
              <button type="button" class="chip" data-placeholder="{{businessName}}" title="Your business name">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                Your Business Name
              </button>
              <button type="button" class="chip" data-placeholder="{{etransferEmail}}" title="Your payment email">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                Payment Email
              </button>
              <button type="button" class="chip" data-placeholder="{{phoneNumber}}" title="Your phone number">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                Your Phone
              </button>
              <button type="button" class="chip" data-placeholder="{{whatsappLink}}" title="Your WhatsApp link">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                WhatsApp Link
              </button>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="firstNoticeMessage">Message Text</label>
            <div class="textarea-wrapper">
              <textarea class="form-textarea" id="firstNoticeMessage" placeholder="Write your first payment request message here...&#10;&#10;Example:&#10;Hi {{customerName}}! Your tiffin bill for {{month}} is {{balance}} ({{numTiffins}} tiffins). Please send via e-Transfer to {{etransferEmail}}. Thank you! - {{businessName}}" aria-describedby="firstNoticeCounter"></textarea>
              <span id="firstNoticeCounter" class="char-counter">0 / 1600</span>
            </div>
          </div>

          <button type="button" class="btn btn-secondary" onclick="previewTemplate('firstNotice')">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            See Preview
          </button>

          <div id="firstNoticePreview" class="preview-section hidden">
            <div class="preview-header">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
              This is what customers will see (with sample data):
            </div>
            <div class="preview-content"></div>
          </div>
        </div>

        <!-- Follow-up Template -->
        <div id="template-followUp" class="template-panel" role="tabpanel">
          <div class="form-group">
            <label class="form-label" for="followUpName">Message Name</label>
            <p class="form-hint">A short name to identify this message type</p>
            <input type="text" class="form-input" id="followUpName" maxlength="50" placeholder="e.g., Follow-up Reminder">
          </div>

          <div class="placeholder-section">
            <div class="placeholder-label">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5"></path>
                <path d="M2 12l10 5 10-5"></path>
              </svg>
              Click to insert customer information:
            </div>
            <div class="placeholder-chips" data-target="followUpMessage">
              <button type="button" class="chip" data-placeholder="{{customerName}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                Customer's Name
              </button>
              <button type="button" class="chip" data-placeholder="{{balance}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                Amount Owed
              </button>
              <button type="button" class="chip" data-placeholder="{{numTiffins}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                Number of Tiffins
              </button>
              <button type="button" class="chip" data-placeholder="{{month}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                Month
              </button>
              <button type="button" class="chip" data-placeholder="{{businessName}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                Your Business Name
              </button>
              <button type="button" class="chip" data-placeholder="{{etransferEmail}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                Payment Email
              </button>
              <button type="button" class="chip" data-placeholder="{{phoneNumber}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                Your Phone
              </button>
              <button type="button" class="chip" data-placeholder="{{whatsappLink}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                WhatsApp Link
              </button>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="followUpMessage">Message Text</label>
            <div class="textarea-wrapper">
              <textarea class="form-textarea" id="followUpMessage" placeholder="Write your follow-up reminder message here..." aria-describedby="followUpCounter"></textarea>
              <span id="followUpCounter" class="char-counter">0 / 1600</span>
            </div>
          </div>

          <button type="button" class="btn btn-secondary" onclick="previewTemplate('followUp')">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            See Preview
          </button>

          <div id="followUpPreview" class="preview-section hidden">
            <div class="preview-header">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
              This is what customers will see (with sample data):
            </div>
            <div class="preview-content"></div>
          </div>
        </div>

        <!-- Final Notice Template -->
        <div id="template-finalNotice" class="template-panel" role="tabpanel">
          <div class="form-group">
            <label class="form-label" for="finalNoticeName">Message Name</label>
            <p class="form-hint">A short name to identify this message type</p>
            <input type="text" class="form-input" id="finalNoticeName" maxlength="50" placeholder="e.g., Final Notice">
          </div>

          <div class="placeholder-section">
            <div class="placeholder-label">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5"></path>
                <path d="M2 12l10 5 10-5"></path>
              </svg>
              Click to insert customer information:
            </div>
            <div class="placeholder-chips" data-target="finalNoticeMessage">
              <button type="button" class="chip" data-placeholder="{{customerName}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                Customer's Name
              </button>
              <button type="button" class="chip" data-placeholder="{{balance}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                Amount Owed
              </button>
              <button type="button" class="chip" data-placeholder="{{numTiffins}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                Number of Tiffins
              </button>
              <button type="button" class="chip" data-placeholder="{{month}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                Month
              </button>
              <button type="button" class="chip" data-placeholder="{{businessName}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                Your Business Name
              </button>
              <button type="button" class="chip" data-placeholder="{{etransferEmail}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                Payment Email
              </button>
              <button type="button" class="chip" data-placeholder="{{phoneNumber}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                Your Phone
              </button>
              <button type="button" class="chip" data-placeholder="{{whatsappLink}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                WhatsApp Link
              </button>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="finalNoticeMessage">Message Text</label>
            <div class="textarea-wrapper">
              <textarea class="form-textarea" id="finalNoticeMessage" placeholder="Write your final notice message here..." aria-describedby="finalNoticeCounter"></textarea>
              <span id="finalNoticeCounter" class="char-counter">0 / 1600</span>
            </div>
          </div>

          <button type="button" class="btn btn-secondary" onclick="previewTemplate('finalNotice')">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            See Preview
          </button>

          <div id="finalNoticePreview" class="preview-section hidden">
            <div class="preview-header">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
              This is what customers will see (with sample data):
            </div>
            <div class="preview-content"></div>
          </div>
        </div>
      </div>

      <!-- Thank You Message -->
      <div class="card" id="thankYouCard">
        <div class="card-header">
          <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
          </svg>
          <div class="card-header-text">
            <h2 class="card-title">Thank You Message</h2>
            <p class="card-subtitle">Sent when you mark a payment as "Paid"</p>
          </div>
        </div>

        <div id="autoThankYouCard" class="toggle-card" style="margin-bottom: var(--space-4);">
          <div class="toggle-info">
            <div class="toggle-title">
              Auto-Send Enabled
              <span id="autoThankYouBadge" class="toggle-badge">On</span>
            </div>
            <div class="toggle-description" id="autoThankYouDescription">Automatically send this message when payment is marked "Paid"</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="autoThankYouEnabled" aria-describedby="autoThankYouDescription" checked>
            <span class="toggle-track"></span>
          </label>
        </div>

        <div id="autoThankYouFeedback" class="tip-box" style="margin-bottom: var(--space-4); margin-top: 0;">
          <svg class="tip-box-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          <span id="autoThankYouFeedbackText">Active: This message will be sent automatically when you mark a payment as "Paid".</span>
        </div>

        <div class="placeholder-section">
          <div class="placeholder-label">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
              <path d="M2 17l10 5 10-5"></path>
              <path d="M2 12l10 5 10-5"></path>
            </svg>
            Click to insert customer information:
          </div>
          <div class="placeholder-chips" data-target="thankYouMessage">
            <button type="button" class="chip" data-placeholder="{{customerName}}">
              <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
              Customer's Name
            </button>
            <button type="button" class="chip" data-placeholder="{{orderId}}">
              <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
              Order ID
            </button>
            <button type="button" class="chip" data-placeholder="{{businessName}}">
              <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
              Your Business Name
            </button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="thankYouMessage">Message Text</label>
          <div class="textarea-wrapper">
            <textarea class="form-textarea" id="thankYouMessage" placeholder="Write your thank you message here...&#10;&#10;Example:&#10;Thank you {{customerName}}! We received your payment for order {{orderId}}. We appreciate your business! - {{businessName}}" aria-describedby="thankYouCounter"></textarea>
            <span id="thankYouCounter" class="char-counter">0 / 1600</span>
          </div>
        </div>

        <button type="button" class="btn btn-secondary" onclick="previewTemplate('thankYou')">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
          See Preview
        </button>

        <div id="thankYouPreview" class="preview-section hidden">
          <div class="preview-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            This is what customers will see (with sample data):
          </div>
          <div class="preview-content"></div>
        </div>
      </div>
    </section>

    <!-- Behavior Tab -->
    <section id="panel-behavior" class="tab-panel" role="tabpanel" aria-labelledby="tab-behavior">
      <div class="info-box">
        <svg class="info-box-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <div class="info-box-content">
          <div class="info-box-title">Behavior Settings</div>
          <div class="info-box-text">Configure how the billing system behaves â€” set a test customer for previews, customize status colors, and adjust processing limits. The defaults work well for most users.</div>
        </div>
      </div>

      <!-- Test Customer Card -->
      <div class="card">
        <div class="card-header">
          <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"></path>
            <circle cx="8.5" cy="7" r="4"></circle>
            <line x1="20" y1="8" x2="20" y2="14"></line>
            <line x1="23" y1="11" x2="17" y2="11"></line>
          </svg>
          <div class="card-header-text">
            <h2 class="card-title">Test Customer</h2>
            <p class="card-subtitle">Use a real customer for template previews and test messages</p>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="testOrderId">Test Customer Order ID</label>
          <p class="form-hint">Enter an Order ID from your spreadsheet. This customer's real data will be used for template previews and test messages. Leave empty to use sample data.</p>
          <input type="text" class="form-input" id="testOrderId" placeholder="e.g. ORD-2024-001">
        </div>

        <div class="tip-box">
          <svg class="tip-box-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
          </svg>
          <span><strong>Tip:</strong> Set this to see realistic template previews with real customer data instead of "John Doe".</span>
        </div>

      </div>

      <!-- Colors Card -->
      <div class="card">
        <div class="card-header">
          <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path>
          </svg>
          <div class="card-header-text">
            <h2 class="card-title">Status Colors</h2>
            <p class="card-subtitle">Colors shown in your spreadsheet after sending messages</p>
          </div>
        </div>

        <p class="form-hint" style="margin-bottom: var(--space-4);">After sending messages, the "Message Status" column in your spreadsheet will be colored to show what happened:</p>

        <div class="color-grid">
          <div class="color-item">
            <input type="color" class="color-input" id="colorSuccess" value="#d9ead3" aria-label="Success color">
            <div class="color-info">
              <div class="color-label">Message Sent Successfully</div>
              <div class="color-description">Shows when a message was delivered</div>
            </div>
            <div class="color-preview" id="previewSuccess" style="background: #d9ead3;">Sent</div>
          </div>

          <div class="color-item">
            <input type="color" class="color-input" id="colorError" value="#f4cccc" aria-label="Error color">
            <div class="color-info">
              <div class="color-label">Message Failed</div>
              <div class="color-description">Shows when there was a problem sending</div>
            </div>
            <div class="color-preview" id="previewError" style="background: #f4cccc;">Error</div>
          </div>

          <div class="color-item">
            <input type="color" class="color-input" id="colorDryRun" value="#fff2cc" aria-label="Test mode color">
            <div class="color-info">
              <div class="color-label">Test Mode (Not Sent)</div>
              <div class="color-description">Shows when Test Mode was on</div>
            </div>
            <div class="color-preview" id="previewDryRun" style="background: #fff2cc;">Test</div>
          </div>
        </div>
      </div>

      <!-- Advanced Options (Collapsible) -->
      <button type="button" class="advanced-toggle" id="advancedToggle" onclick="toggleAdvanced()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
        Advanced Settings
      </button>

      <div class="advanced-content" id="advancedContent">

        <!-- Twilio Credentials Section -->
        <div class="advanced-section">
          <div class="advanced-section-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            Twilio SMS Credentials
          </div>
          <div class="advanced-section-body">
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label" for="advAccountSid">Account SID</label>
                <p class="form-hint">Starts with AC, found on your Twilio dashboard</p>
                <input type="text" class="form-input" id="advAccountSid" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" autocomplete="off">
              </div>

              <div class="form-group">
                <label class="form-label" for="advAuthToken">Auth Token</label>
                <p class="form-hint">Secret token from your Twilio Console</p>
                <div class="input-with-toggle">
                  <input type="password" class="form-input" id="advAuthToken" placeholder="Your auth token" autocomplete="off">
                  <button type="button" class="input-toggle-btn" onclick="toggleTokenVisibility()" aria-label="Toggle token visibility">
                    <svg id="tokenEyeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                  </button>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label" for="advTwilioPhone">Twilio Phone Number</label>
                <p class="form-hint">Your Twilio number in +1XXXXXXXXXX format</p>
                <input type="text" class="form-input" id="advTwilioPhone" placeholder="+1XXXXXXXXXX" autocomplete="off">
              </div>
            </div>

            <div class="advanced-btn-row">
              <button type="button" class="btn btn-secondary" id="advTestTwilioBtn" onclick="testTwilioFromAdvanced()">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;">
                  <polyline points="23 4 23 10 17 10"></polyline>
                  <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                </svg>
                Test Connection
              </button>
              <div id="advTwilioStatus" class="credential-inline-status not-set">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="12"></line>
                  <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                <span id="advTwilioStatusText">Not configured</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Processing Options Section -->
        <div class="advanced-section">
          <div class="advanced-section-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"></path>
            </svg>
            Processing Options
          </div>
          <div class="advanced-section-body">
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label" for="batchSize">Messages Per Batch</label>
                <p class="form-hint">How many to send at once (1-200)</p>
                <input type="number" class="form-input" id="batchSize" min="1" max="200" value="75">
              </div>

              <div class="form-group">
                <label class="form-label" for="messageDelayMs">Delay Between Messages</label>
                <p class="form-hint">Milliseconds between sends (500-5000)</p>
                <input type="number" class="form-input" id="messageDelayMs" min="500" max="5000" step="100" value="1000">
              </div>

              <div class="form-group">
                <label class="form-label" for="headerRowIndex">Header Row Number</label>
                <p class="form-hint">Row with column titles (usually 1)</p>
                <input type="number" class="form-input" id="headerRowIndex" min="1" max="100" value="1">
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- Columns Tab -->
    <section id="panel-columns" class="tab-panel" role="tabpanel" aria-labelledby="tab-columns">
      <div class="info-box">
        <svg class="info-box-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <div class="info-box-content">
          <div class="info-box-title">Map Your Spreadsheet Columns</div>
          <div class="info-box-text">Tell the system which columns in your spreadsheet contain customer data. Use the <strong>Auto-Detect</strong> button for quick setup, then review and adjust as needed.</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
            <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
            <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
          </svg>
          <div class="card-header-text">
            <h2 class="card-title">Column Names</h2>
            <p class="card-subtitle">Match your spreadsheet columns to the required fields</p>
          </div>
        </div>

        <p class="form-hint" style="margin-bottom: var(--space-4);">Select the column name from your spreadsheet for each field. If you don't see your columns, click "Refresh" below.</p>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label" for="colPhoneNumber">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
              Customer Phone Number
            </label>
            <p class="form-hint">The column with customer phone numbers</p>
            <select class="form-select" id="colPhoneNumber"></select>
          </div>

          <div class="form-group">
            <label class="form-label" for="colCustomerName">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
              Customer Name
            </label>
            <p class="form-hint">The column with customer names</p>
            <select class="form-select" id="colCustomerName"></select>
          </div>

          <div class="form-group">
            <label class="form-label" for="colBalance">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
              Amount Owed (Balance)
            </label>
            <p class="form-hint">The column with how much each customer owes</p>
            <select class="form-select" id="colBalance"></select>
          </div>

          <div class="form-group">
            <label class="form-label" for="colNumTiffins">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
              Number of Tiffins
            </label>
            <p class="form-hint">The column with tiffin count per customer</p>
            <select class="form-select" id="colNumTiffins"></select>
          </div>

          <div class="form-group">
            <label class="form-label" for="colDueDate">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
              Due Date / Month
            </label>
            <p class="form-hint">The column with billing date or month</p>
            <select class="form-select" id="colDueDate"></select>
          </div>

          <div class="form-group">
            <label class="form-label" for="colMessageStatus">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
              Message Status
            </label>
            <p class="form-hint">The column where we record if message was sent</p>
            <select class="form-select" id="colMessageStatus"></select>
          </div>

          <div class="form-group">
            <label class="form-label" for="colOrderId">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line></svg>
              Order ID
            </label>
            <p class="form-hint">The column with order/invoice numbers</p>
            <select class="form-select" id="colOrderId"></select>
          </div>

          <div class="form-group">
            <label class="form-label" for="colPaymentStatus">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
              Payment Status
            </label>
            <p class="form-hint">The column showing "Paid" or "Unpaid"</p>
            <select class="form-select" id="colPaymentStatus"></select>
          </div>
        </div>

        <button type="button" class="btn btn-secondary" onclick="refreshHeaders()" style="margin-top: var(--space-4);">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
          </svg>
          Refresh Column List
        </button>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-actions">
      <button type="button" class="btn btn-ghost btn-sm" onclick="exportSettingsUI()" title="Save settings to a file">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        Backup
      </button>
      <button type="button" class="btn btn-ghost btn-sm" onclick="importSettingsUI()" title="Load settings from a file">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Restore
      </button>
      <button type="button" class="btn btn-danger btn-sm" onclick="confirmReset()" title="Reset all settings">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18"></path>
          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
        </svg>
        Reset All
      </button>
    </div>
    <div class="footer-right">
      <button type="button" class="btn btn-secondary" onclick="google.script.host.close()">
        Cancel
      </button>
      <button type="button" class="btn btn-primary" id="saveBtn" onclick="saveSettingsUI()">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
          <polyline points="17 21 17 13 7 13 7 21"></polyline>
          <polyline points="7 3 7 8 15 8"></polyline>
        </svg>
        Save Changes
      </button>
    </div>
  </footer>

  <?!= include('settings-core.js') ?>
  <?!= include('settings-wizard') ?>
  <?!= include('shared-utils') ?>
</body>
</html>
