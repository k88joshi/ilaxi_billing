<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <?!= include('design-tokens') ?>
  <style>
    /* ============================================
       Header
       ============================================ */
    .header {
      background: linear-gradient(135deg, var(--color-primary) 0%, #8b2020 100%);
      padding: var(--space-3) var(--space-5);
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 200px;
      height: 200px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
    }

    .header::after {
      content: '';
      position: absolute;
      bottom: -30%;
      left: -10%;
      width: 120px;
      height: 120px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 50%;
    }

    .header-content {
      position: relative;
      z-index: 1;
    }

    .header h1 {
      color: white;
      font-size: var(--text-lg);
      font-weight: 600;
      letter-spacing: -0.02em;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .header-subtitle {
      color: rgba(255, 255, 255, 0.9);
      font-size: var(--text-xs);
    }

    .unsaved-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(8px);
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      color: white;
      margin-top: var(--space-2);
      opacity: 0;
      transform: translateY(-4px);
      transition: var(--transition-base);
    }

    .unsaved-badge.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .unsaved-badge::before {
      content: '';
      width: 6px;
      height: 6px;
      background: #fbbf24;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* ============================================
       Tab Navigation
       ============================================ */
    .tabs {
      display: flex;
      background: var(--color-surface);
      border-bottom: 1px solid var(--color-border);
      padding: 0 var(--space-4);
      overflow-x: auto;
      scrollbar-width: none;
    }

    .tabs::-webkit-scrollbar {
      display: none;
    }

    .tab {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-2) var(--space-3);
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: var(--transition-fast);
      white-space: nowrap;
      position: relative;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
    }

    .tab:hover {
      color: var(--color-text);
      background: var(--color-border-light);
    }

    .tab.active {
      color: var(--color-primary);
      border-bottom-color: var(--color-primary);
    }

    .tab-icon {
      width: 15px;
      height: 15px;
      opacity: 0.7;
    }

    .tab.active .tab-icon {
      opacity: 1;
    }

    .tab-number {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      font-size: var(--text-xs);
      font-weight: 600;
      background: var(--color-border);
      color: var(--color-text-secondary);
      border-radius: 50%;
      margin-right: var(--space-1);
    }

    .tab.active .tab-number {
      background: var(--color-primary);
      color: white;
    }

    /* ============================================
       Content Area
       ============================================ */
    .content {
      padding: var(--space-4);
      padding-bottom: 80px;
      max-height: calc(100vh - 140px);
      overflow-y: auto;
    }

    .tab-panel {
      display: none;
      animation: fadeIn var(--transition-base);
    }

    .tab-panel.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ============================================
       Info Box (Friendly Guidance)
       ============================================ */
    .info-box {
      background: var(--color-info-light);
      border: 1px solid #93c5fd;
      border-radius: var(--radius-md);
      padding: var(--space-3);
      margin-bottom: var(--space-4);
      display: flex;
      gap: var(--space-2);
    }

    .info-box-icon {
      flex-shrink: 0;
      width: 18px;
      height: 18px;
      color: var(--color-info);
    }

    .info-box-content {
      flex: 1;
    }

    .info-box-title {
      font-weight: 600;
      color: #1e40af;
      margin-bottom: 2px;
      font-size: var(--text-sm);
    }

    .info-box-text {
      font-size: var(--text-xs);
      color: #1e40af;
      line-height: 1.4;
    }

    .tip-box {
      background: var(--color-success-light);
      border: 1px solid #6ee7b7;
      border-radius: var(--radius-md);
      padding: var(--space-2) var(--space-3);
      margin-top: var(--space-2);
      font-size: var(--text-xs);
      color: #065f46;
      display: flex;
      align-items: flex-start;
      gap: var(--space-2);
    }

    .tip-box-icon {
      flex-shrink: 0;
      width: 16px;
      height: 16px;
      margin-top: 2px;
    }

    /* ============================================
       Cards
       ============================================ */
    .card {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
      box-shadow: var(--shadow-sm);
      transition: var(--transition-base);
    }

    .card:hover {
      box-shadow: var(--shadow-md);
    }

    .card:last-child {
      margin-bottom: 0;
    }

    /* Two-column grid for forms */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);
    }

    .form-grid .form-group {
      margin-bottom: 0;
    }

    .form-grid .form-group.full-width {
      grid-column: 1 / -1;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-3);
      padding-bottom: var(--space-2);
      border-bottom: 1px solid var(--color-border-light);
    }

    .card-icon {
      width: 20px;
      height: 20px;
      color: var(--color-primary);
      flex-shrink: 0;
    }

    .card-header-text {
      flex: 1;
    }

    .card-title {
      font-size: var(--text-base);
      font-weight: 600;
      color: var(--color-text);
    }

    .card-subtitle {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      margin-top: 1px;
    }

    /* ============================================
       Form Elements
       ============================================ */
    .form-group {
      margin-bottom: var(--space-4);
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 2px;
    }

    .form-label .optional {
      font-weight: 400;
      color: var(--color-text-muted);
      font-size: var(--text-xs);
    }

    .form-hint {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-1);
      line-height: 1.4;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: var(--space-2) var(--space-3);
      font-size: var(--text-sm);
      color: var(--color-text);
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      transition: var(--transition-fast);
    }

    .form-input:hover,
    .form-select:hover,
    .form-textarea:hover {
      border-color: #cbd5e1;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: var(--shadow-focus);
    }

    .form-input::placeholder,
    .form-textarea::placeholder {
      color: var(--color-text-muted);
    }

    .form-textarea {
      min-height: 120px;
      resize: vertical;
      font-family: var(--font-sans);
      font-size: var(--text-sm);
      line-height: 1.5;
    }

    .form-select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right var(--space-3) center;
      padding-right: var(--space-8);
    }

    /* Character Counter */
    .textarea-wrapper {
      position: relative;
    }

    .char-counter {
      position: absolute;
      bottom: var(--space-2);
      right: var(--space-3);
      font-size: var(--text-xs);
      color: var(--color-text-muted);
      background: var(--color-surface);
      padding: 2px var(--space-2);
      border-radius: var(--radius-sm);
    }

    .char-counter.warning {
      color: var(--color-warning);
    }

    .char-counter.error {
      color: var(--color-error);
    }

    /* ============================================
       Toggle Switch
       ============================================ */
    .toggle-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-3);
      background: var(--color-border-light);
      border-radius: var(--radius-md);
      gap: var(--space-3);
    }

    .toggle-card.active {
      background: var(--color-warning-light);
      border: 1px solid #fcd34d;
    }

    .toggle-info {
      flex: 1;
    }

    .toggle-title {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--color-text);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .toggle-badge {
      font-size: var(--text-xs);
      font-weight: 600;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      background: var(--color-success);
      color: white;
    }

    .toggle-badge.warning {
      background: var(--color-warning);
    }

    .toggle-description {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      margin-top: 2px;
      line-height: 1.4;
    }

    .toggle {
      position: relative;
      width: 44px;
      height: 24px;
      flex-shrink: 0;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-track {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: var(--color-border);
      border-radius: var(--radius-full);
      transition: var(--transition-base);
    }

    .toggle-track::before {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      left: 3px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      box-shadow: var(--shadow-md);
      transition: var(--transition-base);
    }

    .toggle input:checked + .toggle-track {
      background: var(--color-warning);
    }

    .toggle input:checked + .toggle-track::before {
      transform: translateX(20px);
    }

    .toggle input:focus + .toggle-track {
      box-shadow: var(--shadow-focus);
    }

    /* ============================================
       Placeholder Chips (Friendly Labels)
       ============================================ */
    .placeholder-section {
      margin-bottom: var(--space-3);
    }

    .placeholder-label {
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-1);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .placeholder-chips {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-2);
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--color-primary);
      background: var(--color-primary-light);
      border: 1px solid transparent;
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .chip:hover {
      background: #ddd6fe;
      transform: translateY(-1px);
      border-color: var(--color-primary);
    }

    .chip:active {
      transform: translateY(0);
    }

    .chip-icon {
      width: 14px;
      height: 14px;
      opacity: 0.7;
    }

    /* ============================================
       Color Picker
       ============================================ */
    .color-grid {
      display: grid;
      gap: var(--space-3);
    }

    .color-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      background: var(--color-border-light);
      border-radius: var(--radius-md);
    }

    .color-input-wrapper {
      position: relative;
    }

    .color-input {
      width: 36px;
      height: 36px;
      padding: 0;
      border: 3px solid white;
      border-radius: var(--radius-md);
      cursor: pointer;
      box-shadow: var(--shadow-md);
      transition: var(--transition-fast);
    }

    .color-input:hover {
      transform: scale(1.05);
    }

    .color-input::-webkit-color-swatch-wrapper {
      padding: 0;
    }

    .color-input::-webkit-color-swatch {
      border: none;
      border-radius: var(--radius-sm);
    }

    .color-info {
      flex: 1;
    }

    .color-label {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--color-text);
    }

    .color-description {
      font-size: var(--text-xs);
      color: var(--color-text-secondary);
      margin-top: 2px;
    }

    .color-preview {
      width: 80px;
      height: 36px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xs);
      font-weight: 500;
      color: rgba(0, 0, 0, 0.6);
    }

    /* ============================================
       Preview Section
       ============================================ */
    .preview-section {
      margin-top: var(--space-3);
      padding: var(--space-3);
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border-radius: var(--radius-md);
      border: 1px solid #86efac;
    }

    .preview-header {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--text-sm);
      font-weight: 600;
      color: #166534;
      margin-bottom: var(--space-3);
    }

    .preview-header svg {
      width: 18px;
      height: 18px;
    }

    .preview-content {
      background: white;
      padding: var(--space-3);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      line-height: 1.5;
      white-space: pre-wrap;
      border: 1px solid #bbf7d0;
      max-height: 200px;
      overflow-y: auto;
    }

    /* ============================================
       Settings Button Overrides
       ============================================ */
    .btn-primary {
      padding: var(--space-2) var(--space-4);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-secondary:hover:not(:disabled) {
      border-color: #cbd5e1;
    }

    /* ============================================
       Footer
       ============================================ */
    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--color-surface);
      border-top: 1px solid var(--color-border);
      padding: var(--space-3) var(--space-4);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-3);
      z-index: 50;
      box-shadow: 0 -4px 12px -1px rgba(0, 0, 0, 0.08);
    }

    .footer-actions {
      display: flex;
      gap: var(--space-2);
    }

    .footer-right {
      display: flex;
      gap: var(--space-3);
    }

    /* ============================================
       Settings Toast Position (top-center)
       ============================================ */
    .toast-container {
      top: var(--space-4);
      left: 50%;
      transform: translateX(-50%);
    }

    .toast { animation: settingsToastIn var(--transition-slow) forwards; }
    .toast-out { animation: settingsToastOut var(--transition-base) forwards; }
    @keyframes settingsToastIn {
      from { opacity: 0; transform: translateY(-16px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes settingsToastOut {
      to { opacity: 0; transform: translateY(-16px); }
    }

    /* ============================================
       Loading Overlay
       ============================================ */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(4px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: var(--space-4);
      z-index: 100;
      opacity: 1;
      transition: var(--transition-base);
    }

    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--color-border);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loading-text {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ============================================
       Template Sub-tabs
       ============================================ */
    .template-tabs {
      display: flex;
      gap: var(--space-2);
      margin-bottom: var(--space-4);
      padding: var(--space-1);
      background: var(--color-border-light);
      border-radius: var(--radius-lg);
    }

    .template-tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-3);
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--color-text-secondary);
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .template-tab:hover {
      color: var(--color-text);
      background: rgba(255, 255, 255, 0.5);
    }

    .template-tab.active {
      color: var(--color-primary);
      background: var(--color-surface);
      box-shadow: var(--shadow-sm);
    }

    .template-tab-number {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      font-size: var(--text-sm);
      font-weight: 600;
      background: var(--color-border);
      color: var(--color-text-secondary);
      border-radius: 50%;
      transition: var(--transition-fast);
    }

    .template-tab.active .template-tab-number {
      background: var(--color-primary);
      color: white;
    }

    .template-tab-label {
      font-size: var(--text-xs);
      text-align: center;
    }

    .template-panel {
      display: none;
      animation: fadeIn var(--transition-base);
    }

    .template-panel.active {
      display: block;
    }

    /* ============================================
       Advanced Section (Collapsible)
       ============================================ */
    .advanced-toggle {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-4);
      width: 100%;
      background: var(--color-border-light);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: var(--transition-fast);
      margin-top: var(--space-4);
    }

    .advanced-toggle:hover {
      background: var(--color-border);
      color: var(--color-text);
    }

    .advanced-toggle svg {
      width: 16px;
      height: 16px;
      transition: transform var(--transition-fast);
    }

    .advanced-toggle.open svg {
      transform: rotate(180deg);
    }

    .advanced-content {
      display: none;
      margin-top: var(--space-4);
      animation: fadeIn var(--transition-base);
    }

    .advanced-content.open {
      display: block;
    }

    /* Advanced Sub-sections */
    .advanced-section {
      background: var(--color-border-light);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border);
      overflow: hidden;
    }

    .advanced-section + .advanced-section {
      margin-top: var(--space-3);
    }

    .advanced-section-header {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-4);
      background: var(--color-bg);
      border-bottom: 1px solid var(--color-border);
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--color-text);
    }

    .advanced-section-header svg {
      width: 16px;
      height: 16px;
      color: var(--color-text-secondary);
      flex-shrink: 0;
    }

    .advanced-section-body {
      padding: var(--space-3) var(--space-4) var(--space-4);
    }

    .advanced-section-body .form-grid {
      gap: var(--space-3);
    }

    .advanced-section-body .form-group {
      margin-bottom: 0;
    }

    .advanced-section-body .form-hint {
      font-size: 11px;
      line-height: 1.3;
      margin-bottom: var(--space-1);
    }

    .advanced-section-body .form-label {
      font-size: var(--text-sm);
      margin-bottom: 2px;
    }

    .advanced-section-body .form-input {
      padding: var(--space-2) var(--space-3);
      font-size: var(--text-sm);
    }

    /* Credential status inline */
    .credential-inline-status {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-md);
      font-size: var(--text-xs);
      font-weight: 500;
      margin-top: var(--space-2);
    }

    .credential-inline-status.connected {
      background: var(--color-success-light);
      color: #065f46;
    }

    .credential-inline-status.not-set {
      background: var(--color-border-light);
      color: var(--color-text-secondary);
    }

    .credential-inline-status.testing {
      background: var(--color-info-light);
      color: #1e40af;
    }

    .credential-inline-status.error {
      background: var(--color-error-light);
      color: #b91c1c;
    }

    .credential-inline-status svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }

    /* Password toggle */
    .input-with-toggle {
      position: relative;
    }

    .input-with-toggle .form-input {
      padding-right: 40px;
    }

    .input-toggle-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      padding: 4px;
      cursor: pointer;
      color: var(--color-text-secondary);
      display: flex;
      align-items: center;
    }

    .input-toggle-btn:hover {
      color: var(--color-text);
    }

    .input-toggle-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Compact button row */
    .advanced-btn-row {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-top: var(--space-3);
    }

    .advanced-btn-row .btn {
      padding: var(--space-1) var(--space-3);
      font-size: var(--text-xs);
    }

    /* ============================================
       Utility Classes
       ============================================ */
    .hidden {
      display: none !important;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* ============================================
       Inline Validation States
       ============================================ */
    .form-input.valid,
    .form-select.valid,
    .form-textarea.valid {
      border-color: var(--color-success);
    }

    .form-input.invalid,
    .form-select.invalid,
    .form-textarea.invalid {
      border-color: var(--color-error);
    }

    .form-input.valid:focus,
    .form-select.valid:focus,
    .form-textarea.valid:focus {
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .form-input.invalid:focus,
    .form-select.invalid:focus,
    .form-textarea.invalid:focus {
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }

    .field-validation {
      display: flex;
      align-items: flex-start;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-md);
      margin-top: var(--space-2);
      font-size: var(--text-sm);
      line-height: 1.4;
      animation: fadeIn var(--transition-base);
    }

    .field-validation.error {
      background: var(--color-error-light);
      color: #b91c1c;
    }

    .field-validation.warning {
      background: var(--color-warning-light);
      color: #92400e;
    }

    .field-validation.success {
      background: var(--color-success-light);
      color: #065f46;
    }

    .field-validation-icon {
      flex-shrink: 0;
      width: 16px;
      height: 16px;
      margin-top: 1px;
    }

    .field-validation-content {
      flex: 1;
    }

    .field-validation-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .field-validation-steps {
      margin-top: var(--space-1);
      padding-left: var(--space-4);
    }

    .field-validation-steps li {
      margin-bottom: 2px;
    }

    .field-validation-link {
      color: inherit;
      text-decoration: underline;
      font-weight: 500;
    }

    .field-validation-link:hover {
      opacity: 0.8;
    }

    /* ============================================
       Progress Bar
       ============================================ */
    .progress-bar-container {
      height: 8px;
      background: var(--color-border);
      border-radius: var(--radius-full);
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--color-primary), #8b2020);
      border-radius: var(--radius-full);
      transition: width 300ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    .progress-bar.indeterminate {
      width: 30%;
      animation: indeterminate 1.5s ease-in-out infinite;
    }

    @keyframes indeterminate {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(400%); }
    }

    /* ============================================
       Onboarding Wizard Overlay
       ============================================ */
    .wizard-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-4);
      animation: fadeIn var(--transition-slow);
    }

    .wizard-overlay.hidden {
      display: none;
    }

    .wizard-container {
      background: var(--color-surface);
      border-radius: var(--radius-xl);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: slideUp var(--transition-slow);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .wizard-header {
      background: linear-gradient(135deg, var(--color-primary) 0%, #8b2020 100%);
      padding: var(--space-6);
      color: white;
      position: relative;
      overflow: hidden;
    }

    .wizard-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 200px;
      height: 200px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
    }

    .wizard-header-content {
      position: relative;
      z-index: 1;
    }

    .wizard-title {
      font-size: var(--text-2xl);
      font-weight: 700;
      margin-bottom: var(--space-1);
    }

    .wizard-subtitle {
      font-size: var(--text-sm);
      opacity: 0.9;
    }

    .wizard-progress {
      margin-top: var(--space-5);
    }

    .wizard-progress-bar {
      height: 6px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: var(--radius-full);
      overflow: hidden;
    }

    .wizard-progress-fill {
      height: 100%;
      background: white;
      border-radius: var(--radius-full);
      transition: width 300ms ease;
    }

    .wizard-steps {
      display: flex;
      justify-content: space-between;
      margin-top: var(--space-3);
    }

    .wizard-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-1);
      flex: 1;
    }

    .wizard-step-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.4);
      transition: var(--transition-fast);
    }

    .wizard-step.active .wizard-step-dot,
    .wizard-step.completed .wizard-step-dot {
      background: white;
    }

    .wizard-step-label {
      font-size: var(--text-xs);
      opacity: 0.7;
      text-align: center;
    }

    .wizard-step.active .wizard-step-label {
      opacity: 1;
      font-weight: 600;
    }

    .wizard-body {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-6);
    }

    .wizard-panel {
      display: none;
      animation: fadeIn var(--transition-base);
    }

    .wizard-panel.active {
      display: block;
    }

    .wizard-section-title {
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: var(--space-2);
    }

    .wizard-section-desc {
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-5);
      line-height: 1.5;
    }

    .wizard-footer {
      padding: var(--space-4) var(--space-6);
      border-top: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      gap: var(--space-3);
      background: var(--color-bg);
    }

    .wizard-footer-left,
    .wizard-footer-right {
      display: flex;
      gap: var(--space-2);
    }

    /* Credential Test Status */
    .credential-test-status {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      margin-top: var(--space-4);
      transition: var(--transition-base);
    }

    .credential-test-status.idle {
      background: var(--color-border-light);
      color: var(--color-text-secondary);
    }

    .credential-test-status.testing {
      background: var(--color-info-light);
      color: #1e40af;
    }

    .credential-test-status.success {
      background: var(--color-success-light);
      color: #065f46;
    }

    .credential-test-status.error {
      background: var(--color-error-light);
      color: #b91c1c;
    }

    .credential-test-icon {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
    }

    .credential-test-content {
      flex: 1;
    }

    .credential-test-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .credential-test-message {
      font-size: var(--text-sm);
    }

    .credential-test-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Auto-detect columns */
    .column-detect-status {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: 500;
    }

    .column-detect-status.high {
      background: var(--color-success-light);
      color: #065f46;
    }

    .column-detect-status.medium {
      background: var(--color-warning-light);
      color: #92400e;
    }

    .column-detect-status.low {
      background: var(--color-error-light);
      color: #b91c1c;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: var(--space-8);
      color: var(--color-text-secondary);
    }

    .empty-state-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto var(--space-4);
      opacity: 0.4;
    }

    .empty-state h3 {
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: var(--space-2);
    }

    .empty-state p {
      font-size: var(--text-sm);
      margin-bottom: var(--space-4);
      line-height: 1.5;
    }

    /* Summary Card for Wizard */
    .summary-card {
      background: var(--color-border-light);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      margin-bottom: var(--space-3);
    }

    .summary-card-title {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--color-text-secondary);
      margin-bottom: var(--space-2);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .summary-card-content {
      font-size: var(--text-base);
      color: var(--color-text);
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: var(--space-2) 0;
      border-bottom: 1px solid var(--color-border);
    }

    .summary-item:last-child {
      border-bottom: none;
    }

    .summary-label {
      color: var(--color-text-secondary);
    }

    .summary-value {
      font-weight: 500;
    }

    .summary-value.success {
      color: var(--color-success);
    }

    .summary-value.warning {
      color: var(--color-warning);
    }

    .summary-value.error {
      color: var(--color-error);
    }

    /* Twilio Connection Card */
    .connection-card {
      background: var(--color-border-light);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      margin-top: var(--space-4);
    }

    .connection-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-3);
    }

    .connection-card-title {
      font-weight: 600;
      color: var(--color-text);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .connection-card-title svg {
      width: 18px;
      height: 18px;
      color: var(--color-primary);
    }

    /* Error Summary Box */
    .error-summary {
      background: var(--color-error-light);
      border: 1px solid #fca5a5;
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
      animation: shake 0.5s ease;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
      20%, 40%, 60%, 80% { transform: translateX(4px); }
    }

    .error-summary-title {
      font-weight: 600;
      color: #b91c1c;
      margin-bottom: var(--space-2);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .error-summary-list {
      list-style: none;
    }

    .error-summary-item {
      font-size: var(--text-sm);
      color: #b91c1c;
      padding: var(--space-1) 0;
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .error-summary-item:hover {
      text-decoration: underline;
    }

    /* ============================================
       Responsive
       ============================================ */
    @media (max-width: 700px) {
      .form-grid {
        grid-template-columns: 1fr;
      }

      .wizard-container {
        max-height: 100vh;
        border-radius: 0;
      }

      .wizard-steps {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loading" class="loading-overlay">
    <div class="spinner" role="status" aria-label="Loading settings"></div>
    <div class="loading-text">Loading your settings...</div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container" role="alert" aria-live="polite"></div>

  <div class="modal-overlay" id="confirmDialog" role="alertdialog" aria-modal="true" aria-labelledby="confirmDialogTitle">
    <div class="modal confirm-modal">
      <div class="modal-header">
        <h3 class="modal-title" id="confirmDialogTitle"></h3>
      </div>
      <div class="modal-body">
        <p id="confirmDialogMessage"></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="confirmDialogCancel">Cancel</button>
        <button class="btn btn-primary" id="confirmDialogConfirm">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Onboarding Wizard Overlay -->
  <div id="wizardOverlay" class="wizard-overlay hidden">
    <div class="wizard-container">
      <div class="wizard-header">
        <div class="wizard-header-content">
          <h1 class="wizard-title">Welcome to Billing Setup!</h1>
          <p class="wizard-subtitle">Let's get your billing system ready in just a few steps</p>
          <div class="wizard-progress">
            <div class="wizard-progress-bar">
              <div id="wizardProgressFill" class="wizard-progress-fill" style="width: 25%"></div>
            </div>
            <div class="wizard-steps">
              <div class="wizard-step active" data-step="1">
                <div class="wizard-step-dot"></div>
                <span class="wizard-step-label">Twilio</span>
              </div>
              <div class="wizard-step" data-step="2">
                <div class="wizard-step-dot"></div>
                <span class="wizard-step-label">Business</span>
              </div>
              <div class="wizard-step" data-step="3">
                <div class="wizard-step-dot"></div>
                <span class="wizard-step-label">Columns</span>
              </div>
              <div class="wizard-step" data-step="4">
                <div class="wizard-step-dot"></div>
                <span class="wizard-step-label">Finish</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="wizard-body">
        <!-- Step 1: Twilio Credentials -->
        <div id="wizardStep1" class="wizard-panel active">
          <h2 class="wizard-section-title">Connect to Twilio</h2>
          <p class="wizard-section-desc">Twilio is the service that sends text messages to your customers. You'll need to create a free account at <a href="https://www.twilio.com/try-twilio" target="_blank" style="color: var(--color-primary);">twilio.com</a> to get your credentials.</p>

          <div class="form-group">
            <label class="form-label" for="wizardAccountSid">Account SID</label>
            <p class="form-hint">Found on your Twilio Console dashboard (starts with "AC")</p>
            <input type="text" class="form-input" id="wizardAccountSid" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" autocomplete="off">
            <div id="wizardAccountSidValidation" class="field-validation hidden"></div>
          </div>

          <div class="form-group">
            <label class="form-label" for="wizardAuthToken">Auth Token</label>
            <p class="form-hint">Click "Show" on your Twilio Console to reveal this secret token</p>
            <input type="password" class="form-input" id="wizardAuthToken" placeholder="Your auth token" autocomplete="off">
            <div id="wizardAuthTokenValidation" class="field-validation hidden"></div>
          </div>

          <div class="form-group">
            <label class="form-label" for="wizardTwilioPhone">Twilio Phone Number</label>
            <p class="form-hint">The phone number you purchased from Twilio (format: +1XXXXXXXXXX)</p>
            <input type="tel" class="form-input" id="wizardTwilioPhone" placeholder="+1 (555) 123-4567" autocomplete="off">
            <div id="wizardTwilioPhoneValidation" class="field-validation hidden"></div>
          </div>

          <div id="wizardCredentialStatus" class="credential-test-status idle">
            <svg class="credential-test-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            <div class="credential-test-content">
              <div class="credential-test-title">Ready to Test</div>
              <div class="credential-test-message">Fill in your credentials above, then click "Test Connection"</div>
            </div>
          </div>
        </div>

        <!-- Step 2: Business Info -->
        <div id="wizardStep2" class="wizard-panel">
          <h2 class="wizard-section-title">Your Business Details</h2>
          <p class="wizard-section-desc">This information appears in the text messages sent to your customers. Make sure it's accurate!</p>

          <div class="form-group">
            <label class="form-label" for="wizardBusinessName">Business Name</label>
            <p class="form-hint">The name customers will see in messages</p>
            <input type="text" class="form-input" id="wizardBusinessName" placeholder="e.g., Ilaxi's Gujarati Tiffin" maxlength="100">
            <div id="wizardBusinessNameValidation" class="field-validation hidden"></div>
          </div>

          <div class="form-group">
            <label class="form-label" for="wizardEtransferEmail">Email for Receiving Payments</label>
            <p class="form-hint">Where customers send Interac e-Transfer payments</p>
            <input type="email" class="form-input" id="wizardEtransferEmail" placeholder="payments@mybusiness.com">
            <div id="wizardEtransferEmailValidation" class="field-validation hidden"></div>
          </div>

          <div class="form-group">
            <label class="form-label" for="wizardPhoneNumber">Your Phone Number</label>
            <p class="form-hint">Customers can call or text this number with questions</p>
            <input type="tel" class="form-input" id="wizardPhoneNumber" placeholder="+1 (416) 555-1234" maxlength="20">
            <div id="wizardPhoneNumberValidation" class="field-validation hidden"></div>
          </div>

          <div class="form-group">
            <label class="form-label" for="wizardWhatsappLink">
              WhatsApp Link
              <span class="optional">(optional)</span>
            </label>
            <p class="form-hint">If you use WhatsApp, customers can send payment screenshots here</p>
            <input type="url" class="form-input" id="wizardWhatsappLink" placeholder="https://wa.me/14165551234">
          </div>
        </div>

        <!-- Step 3: Column Mapping -->
        <div id="wizardStep3" class="wizard-panel">
          <h2 class="wizard-section-title">Connect Your Spreadsheet</h2>
          <p class="wizard-section-desc">We'll try to automatically detect which columns in your spreadsheet contain which information. Review and adjust if needed.</p>

          <div id="wizardColumnStatus" class="credential-test-status idle" style="margin-bottom: var(--space-4); margin-top: 0;">
            <div class="credential-test-spinner"></div>
            <div class="credential-test-content">
              <div class="credential-test-title">Analyzing Your Spreadsheet...</div>
              <div class="credential-test-message">Looking for column headers</div>
            </div>
          </div>

          <div id="wizardColumnsContainer">
            <!-- Will be populated by JavaScript -->
          </div>

          <div id="wizardColumnsEmpty" class="empty-state hidden">
            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="3" y1="9" x2="21" y2="9"></line>
              <line x1="9" y1="21" x2="9" y2="9"></line>
            </svg>
            <h3>No Columns Found</h3>
            <p>Make sure your spreadsheet has a header row with column names like "Customer Name", "Phone Number", etc.</p>
            <button type="button" class="btn btn-secondary" onclick="wizardRefreshColumns()">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
              Refresh Column List
            </button>
          </div>
        </div>

        <!-- Step 4: Confirmation -->
        <div id="wizardStep4" class="wizard-panel">
          <h2 class="wizard-section-title">You're All Set!</h2>
          <p class="wizard-section-desc">Here's a summary of your setup. You can always change these settings later.</p>

          <div class="summary-card">
            <div class="summary-card-title">Twilio Connection</div>
            <div class="summary-card-content">
              <div class="summary-item">
                <span class="summary-label">Status</span>
                <span id="wizardSummaryTwilioStatus" class="summary-value success">Connected</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Phone Number</span>
                <span id="wizardSummaryTwilioPhone" class="summary-value">+1 (555) 123-4567</span>
              </div>
            </div>
          </div>

          <div class="summary-card">
            <div class="summary-card-title">Business Info</div>
            <div class="summary-card-content">
              <div class="summary-item">
                <span class="summary-label">Name</span>
                <span id="wizardSummaryBusinessName" class="summary-value">Your Business</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Payment Email</span>
                <span id="wizardSummaryEmail" class="summary-value">email@example.com</span>
              </div>
            </div>
          </div>

          <div class="summary-card">
            <div class="summary-card-title">Spreadsheet Columns</div>
            <div id="wizardSummaryColumns" class="summary-card-content">
              <!-- Populated by JavaScript -->
            </div>
          </div>

          <div class="tip-box" style="margin-top: var(--space-4);">
            <svg class="tip-box-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
            <span><strong>Tip:</strong> When sending bills, you'll be asked to choose Test Mode or Real Mode each time, so you can safely practice first.</span>
          </div>
        </div>
      </div>

      <div class="wizard-footer">
        <div class="wizard-footer-left">
          <button type="button" class="btn btn-ghost" id="wizardSkipBtn" onclick="skipWizard()">
            Skip for Now
          </button>
        </div>
        <div class="wizard-footer-right">
          <button type="button" class="btn btn-secondary" id="wizardBackBtn" onclick="wizardBack()" style="display: none;">
            Back
          </button>
          <button type="button" class="btn btn-secondary" id="wizardTestBtn" onclick="wizardTestCredentials()">
            Test Connection
          </button>
          <button type="button" class="btn btn-primary" id="wizardNextBtn" onclick="wizardNext()">
            Next Step
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: 4px;">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <h1>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
        Settings
      </h1>
      <p class="header-subtitle">Customize your billing messages and preferences</p>
      <div id="unsavedBadge" class="unsaved-badge">
        You have unsaved changes
      </div>
    </div>
  </header>

  <!-- Tab Navigation -->
  <nav class="tabs" role="tablist" aria-label="Settings sections">
    <button class="tab active" data-tab="business" role="tab" aria-selected="true" aria-controls="panel-business">
      <span class="tab-number">1</span>
      <span>Your Business</span>
    </button>
    <button class="tab" data-tab="templates" role="tab" aria-selected="false" aria-controls="panel-templates">
      <span class="tab-number">2</span>
      <span>Messages</span>
    </button>
    <button class="tab" data-tab="behavior" role="tab" aria-selected="false" aria-controls="panel-behavior">
      <span class="tab-number">3</span>
      <span>Options</span>
    </button>
    <button class="tab" data-tab="columns" role="tab" aria-selected="false" aria-controls="panel-columns">
      <span class="tab-number">4</span>
      <span>Spreadsheet</span>
    </button>
  </nav>

  <!-- Content Area -->
  <main class="content">
    <!-- Business Tab -->
    <section id="panel-business" class="tab-panel active" role="tabpanel" aria-labelledby="tab-business">
      <div class="info-box">
        <svg class="info-box-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <div class="info-box-content">
          <div class="info-box-title">Your Business Details</div>
          <div class="info-box-text">Fill in your business details below. This information appears in every billing message sent to your customers, so they know who the message is from and how to pay.</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
          </svg>
          <div class="card-header-text">
            <h2 class="card-title">Business Details</h2>
            <p class="card-subtitle">Your business name and contact information</p>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label" for="businessName">Business Name</label>
            <p class="form-hint">The name customers will see in messages</p>
            <input type="text" class="form-input" id="businessName" maxlength="100" placeholder="e.g., Ilaxi's Gujarati Tiffin" autocomplete="organization">
          </div>

          <div class="form-group">
            <label class="form-label" for="phoneNumber">Your Phone Number</label>
            <p class="form-hint">Customers can call or text this number with questions</p>
            <input type="tel" class="form-input" id="phoneNumber" maxlength="20" placeholder="e.g., +1 (416) 555-1234" autocomplete="tel">
          </div>

          <div class="form-group">
            <label class="form-label" for="etransferEmail">Email for Receiving Payments</label>
            <p class="form-hint">Where customers send Interac e-Transfer payments</p>
            <input type="email" class="form-input" id="etransferEmail" placeholder="e.g., payments@mybusiness.com" autocomplete="email">
          </div>

          <div class="form-group">
            <label class="form-label" for="whatsappLink">
              WhatsApp Link
              <span class="optional">(optional)</span>
            </label>
            <p class="form-hint">If you use WhatsApp, customers can send payment screenshots here</p>
            <input type="url" class="form-input" id="whatsappLink" placeholder="e.g., https://wa.me/14165551234">
          </div>
        </div>

        <div class="tip-box">
          <svg class="tip-box-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
          </svg>
          <span><strong>Tip:</strong> Double-check your payment email! Customers will send money to this address.</span>
        </div>
      </div>

    </section>

    <!-- Templates Tab -->
    <section id="panel-templates" class="tab-panel" role="tabpanel" aria-labelledby="tab-templates">
      <div class="info-box">
        <svg class="info-box-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <div class="info-box-content">
          <div class="info-box-title">Customize Your Messages</div>
          <div class="info-box-text">Customize the messages sent at each stage of your billing cycle. Click a tab below to edit each template, and use the blue placeholder buttons to insert customer data like name, balance, and due date.</div>
        </div>
      </div>

      <!-- Bill Messages Card with Sub-tabs -->
      <div class="card">
        <div class="card-header">
          <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="12" y1="18" x2="12" y2="12"></line>
            <line x1="9" y1="15" x2="15" y2="15"></line>
          </svg>
          <div class="card-header-text">
            <h2 class="card-title">Payment Request Messages</h2>
            <p class="card-subtitle">Different messages for different situations</p>
          </div>
        </div>

        <p class="form-hint" style="margin-bottom: var(--space-3);">You have 3 types of payment request messages. Use <strong>First Notice</strong> for new bills, <strong>Follow-up</strong> for reminders, and <strong>Final Notice</strong> for overdue payments.</p>

        <!-- Template Type Selector -->
        <div class="template-tabs" role="tablist">
          <button type="button" class="template-tab active" data-template="firstNotice" role="tab" aria-selected="true">
            <span class="template-tab-number">1</span>
            <span class="template-tab-label">First Notice</span>
          </button>
          <button type="button" class="template-tab" data-template="followUp" role="tab" aria-selected="false">
            <span class="template-tab-number">2</span>
            <span class="template-tab-label">Follow-up</span>
          </button>
          <button type="button" class="template-tab" data-template="finalNotice" role="tab" aria-selected="false">
            <span class="template-tab-number">3</span>
            <span class="template-tab-label">Final Notice</span>
          </button>
        </div>

        <!-- First Notice Template -->
        <div id="template-firstNotice" class="template-panel active" role="tabpanel">
          <div class="form-group">
            <label class="form-label" for="firstNoticeName">Message Name</label>
            <p class="form-hint">A short name to identify this message type</p>
            <input type="text" class="form-input" id="firstNoticeName" maxlength="50" placeholder="e.g., First Notice">
          </div>

          <div class="placeholder-section">
            <div class="placeholder-label">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5"></path>
                <path d="M2 12l10 5 10-5"></path>
              </svg>
              Click to insert customer information:
            </div>
            <div class="placeholder-chips" data-target="firstNoticeMessage">
              <button type="button" class="chip" data-placeholder="{{customerName}}" title="The customer's name">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                Customer's Name
              </button>
              <button type="button" class="chip" data-placeholder="{{balance}}" title="Amount they owe">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                Amount Owed
              </button>
              <button type="button" class="chip" data-placeholder="{{numTiffins}}" title="Number of tiffins">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                Number of Tiffins
              </button>
              <button type="button" class="chip" data-placeholder="{{month}}" title="Billing month">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                Month
              </button>
              <button type="button" class="chip" data-placeholder="{{businessName}}" title="Your business name">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                Your Business Name
              </button>
              <button type="button" class="chip" data-placeholder="{{etransferEmail}}" title="Your payment email">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                Payment Email
              </button>
              <button type="button" class="chip" data-placeholder="{{phoneNumber}}" title="Your phone number">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                Your Phone
              </button>
              <button type="button" class="chip" data-placeholder="{{whatsappLink}}" title="Your WhatsApp link">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                WhatsApp Link
              </button>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="firstNoticeMessage">Message Text</label>
            <div class="textarea-wrapper">
              <textarea class="form-textarea" id="firstNoticeMessage" placeholder="Write your first payment request message here...&#10;&#10;Example:&#10;Hi {{customerName}}! Your tiffin bill for {{month}} is {{balance}} ({{numTiffins}} tiffins). Please send via e-Transfer to {{etransferEmail}}. Thank you! - {{businessName}}" aria-describedby="firstNoticeCounter"></textarea>
              <span id="firstNoticeCounter" class="char-counter">0 / 1600</span>
            </div>
          </div>

          <button type="button" class="btn btn-secondary" onclick="previewTemplate('firstNotice')">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            See Preview
          </button>

          <div id="firstNoticePreview" class="preview-section hidden">
            <div class="preview-header">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
              This is what customers will see (with sample data):
            </div>
            <div class="preview-content"></div>
          </div>
        </div>

        <!-- Follow-up Template -->
        <div id="template-followUp" class="template-panel" role="tabpanel">
          <div class="form-group">
            <label class="form-label" for="followUpName">Message Name</label>
            <p class="form-hint">A short name to identify this message type</p>
            <input type="text" class="form-input" id="followUpName" maxlength="50" placeholder="e.g., Follow-up Reminder">
          </div>

          <div class="placeholder-section">
            <div class="placeholder-label">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5"></path>
                <path d="M2 12l10 5 10-5"></path>
              </svg>
              Click to insert customer information:
            </div>
            <div class="placeholder-chips" data-target="followUpMessage">
              <button type="button" class="chip" data-placeholder="{{customerName}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                Customer's Name
              </button>
              <button type="button" class="chip" data-placeholder="{{balance}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                Amount Owed
              </button>
              <button type="button" class="chip" data-placeholder="{{numTiffins}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                Number of Tiffins
              </button>
              <button type="button" class="chip" data-placeholder="{{month}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                Month
              </button>
              <button type="button" class="chip" data-placeholder="{{businessName}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                Your Business Name
              </button>
              <button type="button" class="chip" data-placeholder="{{etransferEmail}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                Payment Email
              </button>
              <button type="button" class="chip" data-placeholder="{{phoneNumber}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                Your Phone
              </button>
              <button type="button" class="chip" data-placeholder="{{whatsappLink}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                WhatsApp Link
              </button>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="followUpMessage">Message Text</label>
            <div class="textarea-wrapper">
              <textarea class="form-textarea" id="followUpMessage" placeholder="Write your follow-up reminder message here..." aria-describedby="followUpCounter"></textarea>
              <span id="followUpCounter" class="char-counter">0 / 1600</span>
            </div>
          </div>

          <button type="button" class="btn btn-secondary" onclick="previewTemplate('followUp')">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            See Preview
          </button>

          <div id="followUpPreview" class="preview-section hidden">
            <div class="preview-header">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
              This is what customers will see (with sample data):
            </div>
            <div class="preview-content"></div>
          </div>
        </div>

        <!-- Final Notice Template -->
        <div id="template-finalNotice" class="template-panel" role="tabpanel">
          <div class="form-group">
            <label class="form-label" for="finalNoticeName">Message Name</label>
            <p class="form-hint">A short name to identify this message type</p>
            <input type="text" class="form-input" id="finalNoticeName" maxlength="50" placeholder="e.g., Final Notice">
          </div>

          <div class="placeholder-section">
            <div class="placeholder-label">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5"></path>
                <path d="M2 12l10 5 10-5"></path>
              </svg>
              Click to insert customer information:
            </div>
            <div class="placeholder-chips" data-target="finalNoticeMessage">
              <button type="button" class="chip" data-placeholder="{{customerName}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                Customer's Name
              </button>
              <button type="button" class="chip" data-placeholder="{{balance}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                Amount Owed
              </button>
              <button type="button" class="chip" data-placeholder="{{numTiffins}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                Number of Tiffins
              </button>
              <button type="button" class="chip" data-placeholder="{{month}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                Month
              </button>
              <button type="button" class="chip" data-placeholder="{{businessName}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                Your Business Name
              </button>
              <button type="button" class="chip" data-placeholder="{{etransferEmail}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                Payment Email
              </button>
              <button type="button" class="chip" data-placeholder="{{phoneNumber}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                Your Phone
              </button>
              <button type="button" class="chip" data-placeholder="{{whatsappLink}}">
                <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                WhatsApp Link
              </button>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="finalNoticeMessage">Message Text</label>
            <div class="textarea-wrapper">
              <textarea class="form-textarea" id="finalNoticeMessage" placeholder="Write your final notice message here..." aria-describedby="finalNoticeCounter"></textarea>
              <span id="finalNoticeCounter" class="char-counter">0 / 1600</span>
            </div>
          </div>

          <button type="button" class="btn btn-secondary" onclick="previewTemplate('finalNotice')">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            See Preview
          </button>

          <div id="finalNoticePreview" class="preview-section hidden">
            <div class="preview-header">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
              This is what customers will see (with sample data):
            </div>
            <div class="preview-content"></div>
          </div>
        </div>
      </div>

      <!-- Thank You Message -->
      <div class="card" id="thankYouCard">
        <div class="card-header">
          <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
          </svg>
          <div class="card-header-text">
            <h2 class="card-title">Thank You Message</h2>
            <p class="card-subtitle">Sent when you mark a payment as "Paid"</p>
          </div>
        </div>

        <div id="autoThankYouCard" class="toggle-card" style="margin-bottom: var(--space-4);">
          <div class="toggle-info">
            <div class="toggle-title">
              Auto-Send Enabled
              <span id="autoThankYouBadge" class="toggle-badge">On</span>
            </div>
            <div class="toggle-description" id="autoThankYouDescription">Automatically send this message when payment is marked "Paid"</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="autoThankYouEnabled" aria-describedby="autoThankYouDescription" checked>
            <span class="toggle-track"></span>
          </label>
        </div>

        <div id="autoThankYouFeedback" class="tip-box" style="margin-bottom: var(--space-4); margin-top: 0;">
          <svg class="tip-box-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          <span id="autoThankYouFeedbackText">Active: This message will be sent automatically when you mark a payment as "Paid".</span>
        </div>

        <div class="placeholder-section">
          <div class="placeholder-label">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
              <path d="M2 17l10 5 10-5"></path>
              <path d="M2 12l10 5 10-5"></path>
            </svg>
            Click to insert customer information:
          </div>
          <div class="placeholder-chips" data-target="thankYouMessage">
            <button type="button" class="chip" data-placeholder="{{customerName}}">
              <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
              Customer's Name
            </button>
            <button type="button" class="chip" data-placeholder="{{orderId}}">
              <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
              Order ID
            </button>
            <button type="button" class="chip" data-placeholder="{{businessName}}">
              <svg class="chip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
              Your Business Name
            </button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="thankYouMessage">Message Text</label>
          <div class="textarea-wrapper">
            <textarea class="form-textarea" id="thankYouMessage" placeholder="Write your thank you message here...&#10;&#10;Example:&#10;Thank you {{customerName}}! We received your payment for order {{orderId}}. We appreciate your business! - {{businessName}}" aria-describedby="thankYouCounter"></textarea>
            <span id="thankYouCounter" class="char-counter">0 / 1600</span>
          </div>
        </div>

        <button type="button" class="btn btn-secondary" onclick="previewTemplate('thankYou')">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
          See Preview
        </button>

        <div id="thankYouPreview" class="preview-section hidden">
          <div class="preview-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            This is what customers will see (with sample data):
          </div>
          <div class="preview-content"></div>
        </div>
      </div>
    </section>

    <!-- Behavior Tab -->
    <section id="panel-behavior" class="tab-panel" role="tabpanel" aria-labelledby="tab-behavior">
      <div class="info-box">
        <svg class="info-box-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <div class="info-box-content">
          <div class="info-box-title">Behavior Settings</div>
          <div class="info-box-text">Configure how the billing system behaves  set a test customer for previews, customize status colors, and adjust processing limits. The defaults work well for most users.</div>
        </div>
      </div>

      <!-- Test Customer Card -->
      <div class="card">
        <div class="card-header">
          <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"></path>
            <circle cx="8.5" cy="7" r="4"></circle>
            <line x1="20" y1="8" x2="20" y2="14"></line>
            <line x1="23" y1="11" x2="17" y2="11"></line>
          </svg>
          <div class="card-header-text">
            <h2 class="card-title">Test Customer</h2>
            <p class="card-subtitle">Use a real customer for template previews and test messages</p>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="testOrderId">Test Customer Order ID</label>
          <p class="form-hint">Enter an Order ID from your spreadsheet. This customer's real data will be used for template previews and test messages. Leave empty to use sample data.</p>
          <input type="text" class="form-input" id="testOrderId" placeholder="e.g. ORD-2024-001">
        </div>

        <div class="tip-box">
          <svg class="tip-box-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
          </svg>
          <span><strong>Tip:</strong> Set this to see realistic template previews with real customer data instead of "John Doe".</span>
        </div>

      </div>

      <!-- Colors Card -->
      <div class="card">
        <div class="card-header">
          <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path>
          </svg>
          <div class="card-header-text">
            <h2 class="card-title">Status Colors</h2>
            <p class="card-subtitle">Colors shown in your spreadsheet after sending messages</p>
          </div>
        </div>

        <p class="form-hint" style="margin-bottom: var(--space-4);">After sending messages, the "Message Status" column in your spreadsheet will be colored to show what happened:</p>

        <div class="color-grid">
          <div class="color-item">
            <input type="color" class="color-input" id="colorSuccess" value="#d9ead3" aria-label="Success color">
            <div class="color-info">
              <div class="color-label">Message Sent Successfully</div>
              <div class="color-description">Shows when a message was delivered</div>
            </div>
            <div class="color-preview" id="previewSuccess" style="background: #d9ead3;">Sent</div>
          </div>

          <div class="color-item">
            <input type="color" class="color-input" id="colorError" value="#f4cccc" aria-label="Error color">
            <div class="color-info">
              <div class="color-label">Message Failed</div>
              <div class="color-description">Shows when there was a problem sending</div>
            </div>
            <div class="color-preview" id="previewError" style="background: #f4cccc;">Error</div>
          </div>

          <div class="color-item">
            <input type="color" class="color-input" id="colorDryRun" value="#fff2cc" aria-label="Test mode color">
            <div class="color-info">
              <div class="color-label">Test Mode (Not Sent)</div>
              <div class="color-description">Shows when Test Mode was on</div>
            </div>
            <div class="color-preview" id="previewDryRun" style="background: #fff2cc;">Test</div>
          </div>
        </div>
      </div>

      <!-- Advanced Options (Collapsible) -->
      <button type="button" class="advanced-toggle" id="advancedToggle" onclick="toggleAdvanced()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
        Advanced Settings
      </button>

      <div class="advanced-content" id="advancedContent">

        <!-- Twilio Credentials Section -->
        <div class="advanced-section">
          <div class="advanced-section-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            Twilio SMS Credentials
          </div>
          <div class="advanced-section-body">
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label" for="advAccountSid">Account SID</label>
                <p class="form-hint">Starts with AC, found on your Twilio dashboard</p>
                <input type="text" class="form-input" id="advAccountSid" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" autocomplete="off">
              </div>

              <div class="form-group">
                <label class="form-label" for="advAuthToken">Auth Token</label>
                <p class="form-hint">Secret token from your Twilio Console</p>
                <div class="input-with-toggle">
                  <input type="password" class="form-input" id="advAuthToken" placeholder="Your auth token" autocomplete="off">
                  <button type="button" class="input-toggle-btn" onclick="toggleTokenVisibility()" aria-label="Toggle token visibility">
                    <svg id="tokenEyeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                  </button>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label" for="advTwilioPhone">Twilio Phone Number</label>
                <p class="form-hint">Your Twilio number in +1XXXXXXXXXX format</p>
                <input type="text" class="form-input" id="advTwilioPhone" placeholder="+1XXXXXXXXXX" autocomplete="off">
              </div>
            </div>

            <div class="advanced-btn-row">
              <button type="button" class="btn btn-secondary" id="advTestTwilioBtn" onclick="testTwilioFromAdvanced()">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;">
                  <polyline points="23 4 23 10 17 10"></polyline>
                  <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                </svg>
                Test Connection
              </button>
              <div id="advTwilioStatus" class="credential-inline-status not-set">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="12"></line>
                  <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                <span id="advTwilioStatusText">Not configured</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Processing Options Section -->
        <div class="advanced-section">
          <div class="advanced-section-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"></path>
            </svg>
            Processing Options
          </div>
          <div class="advanced-section-body">
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label" for="batchSize">Messages Per Batch</label>
                <p class="form-hint">How many to send at once (1-200)</p>
                <input type="number" class="form-input" id="batchSize" min="1" max="200" value="75">
              </div>

              <div class="form-group">
                <label class="form-label" for="messageDelayMs">Delay Between Messages</label>
                <p class="form-hint">Milliseconds between sends (500-5000)</p>
                <input type="number" class="form-input" id="messageDelayMs" min="500" max="5000" step="100" value="1000">
              </div>

              <div class="form-group">
                <label class="form-label" for="headerRowIndex">Header Row Number</label>
                <p class="form-hint">Row with column titles (usually 1)</p>
                <input type="number" class="form-input" id="headerRowIndex" min="1" max="100" value="1">
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- Columns Tab -->
    <section id="panel-columns" class="tab-panel" role="tabpanel" aria-labelledby="tab-columns">
      <div class="info-box">
        <svg class="info-box-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <div class="info-box-content">
          <div class="info-box-title">Map Your Spreadsheet Columns</div>
          <div class="info-box-text">Tell the system which columns in your spreadsheet contain customer data. Use the <strong>Auto-Detect</strong> button for quick setup, then review and adjust as needed.</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
            <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
            <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
          </svg>
          <div class="card-header-text">
            <h2 class="card-title">Column Names</h2>
            <p class="card-subtitle">Match your spreadsheet columns to the required fields</p>
          </div>
        </div>

        <p class="form-hint" style="margin-bottom: var(--space-4);">Select the column name from your spreadsheet for each field. If you don't see your columns, click "Refresh" below.</p>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label" for="colPhoneNumber">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
              Customer Phone Number
            </label>
            <p class="form-hint">The column with customer phone numbers</p>
            <select class="form-select" id="colPhoneNumber"></select>
          </div>

          <div class="form-group">
            <label class="form-label" for="colCustomerName">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
              Customer Name
            </label>
            <p class="form-hint">The column with customer names</p>
            <select class="form-select" id="colCustomerName"></select>
          </div>

          <div class="form-group">
            <label class="form-label" for="colBalance">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
              Amount Owed (Balance)
            </label>
            <p class="form-hint">The column with how much each customer owes</p>
            <select class="form-select" id="colBalance"></select>
          </div>

          <div class="form-group">
            <label class="form-label" for="colNumTiffins">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
              Number of Tiffins
            </label>
            <p class="form-hint">The column with tiffin count per customer</p>
            <select class="form-select" id="colNumTiffins"></select>
          </div>

          <div class="form-group">
            <label class="form-label" for="colDueDate">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
              Due Date / Month
            </label>
            <p class="form-hint">The column with billing date or month</p>
            <select class="form-select" id="colDueDate"></select>
          </div>

          <div class="form-group">
            <label class="form-label" for="colMessageStatus">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
              Message Status
            </label>
            <p class="form-hint">The column where we record if message was sent</p>
            <select class="form-select" id="colMessageStatus"></select>
          </div>

          <div class="form-group">
            <label class="form-label" for="colOrderId">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line></svg>
              Order ID
            </label>
            <p class="form-hint">The column with order/invoice numbers</p>
            <select class="form-select" id="colOrderId"></select>
          </div>

          <div class="form-group">
            <label class="form-label" for="colPaymentStatus">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
              Payment Status
            </label>
            <p class="form-hint">The column showing "Paid" or "Unpaid"</p>
            <select class="form-select" id="colPaymentStatus"></select>
          </div>
        </div>

        <button type="button" class="btn btn-secondary" onclick="refreshHeaders()" style="margin-top: var(--space-4);">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
          </svg>
          Refresh Column List
        </button>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-actions">
      <button type="button" class="btn btn-ghost btn-sm" onclick="exportSettingsUI()" title="Save settings to a file">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        Backup
      </button>
      <button type="button" class="btn btn-ghost btn-sm" onclick="importSettingsUI()" title="Load settings from a file">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Restore
      </button>
      <button type="button" class="btn btn-danger btn-sm" onclick="confirmReset()" title="Reset all settings">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18"></path>
          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
        </svg>
        Reset All
      </button>
    </div>
    <div class="footer-right">
      <button type="button" class="btn btn-secondary" onclick="google.script.host.close()">
        Cancel
      </button>
      <button type="button" class="btn btn-primary" id="saveBtn" onclick="saveSettingsUI()">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
          <polyline points="17 21 17 13 7 13 7 21"></polyline>
          <polyline points="7 3 7 8 15 8"></polyline>
        </svg>
        Save Changes
      </button>
    </div>
  </footer>

  <script>
    // ============================================
    // State Management
    // ============================================
    var currentSettings = null;
    var originalSettings = null;
    var sheetHeaders = [];
    var hasUnsavedChanges = false;
    var wizardStep = 1;
    var wizardData = {
      accountSid: '',
      authToken: '',
      twilioPhone: '',
      credentialsValid: false,
      businessName: '',
      etransferEmail: '',
      phoneNumber: '',
      whatsappLink: '',
      columns: {},
      columnDetections: {}
    };
    var isFirstTimeUser = false;

    // ============================================
    // Validation Rules
    // ============================================
    var validationRules = {
      email: {
        pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
        message: 'Please enter a valid email address',
        example: 'e.g., payments@mybusiness.com'
      },
      phone: {
        pattern: /^\+?[\d\s\-\(\)]{7,20}$/,
        message: 'Please enter a valid phone number',
        example: 'Include country code, e.g., +1 (647) 555-1234'
      },
      twilioPhone: {
        pattern: /^\+1\d{10}$/,
        message: 'Twilio phone must be in format +1XXXXXXXXXX',
        example: 'e.g., +14155551234'
      },
      accountSid: {
        pattern: /^AC[a-f0-9]{32}$/i,
        message: 'Account SID should start with "AC" and be 34 characters',
        example: 'Found on your Twilio Console dashboard'
      },
      authToken: {
        pattern: /^[a-f0-9]{32}$/i,
        message: 'Auth Token should be 32 characters',
        example: 'Click "Show" on your Twilio Console to reveal it'
      },
      hexColor: {
        pattern: /^#[0-9A-Fa-f]{6}$/,
        message: 'Invalid color format',
        example: 'Use #RRGGBB format, e.g., #d9ead3'
      },
      required: {
        pattern: /.+/,
        message: 'This field is required',
        example: ''
      },
      templateLength: {
        min: 50,
        max: 1600,
        message: 'Message must be between 50-1600 characters',
        example: 'SMS messages work best between 160-320 characters'
      }
    };

    // Error guidance for common issues
    var errorGuidance = {
      'AUTH_FAILED': {
        title: 'Authentication Failed',
        steps: [
          'Double-check your Account SID - it should start with "AC"',
          'Make sure you copied the Auth Token correctly (no extra spaces)',
          'Verify you\'re using live credentials, not test credentials'
        ],
        link: 'https://www.twilio.com/console'
      },
      'PHONE_NOT_FOUND': {
        title: 'Phone Number Not Found',
        steps: [
          'Make sure the phone number is in E.164 format (+1XXXXXXXXXX)',
          'Verify this number is registered to your Twilio account',
          'Check that your Twilio account has SMS capability enabled'
        ],
        link: 'https://www.twilio.com/console/phone-numbers/incoming'
      },
      'INVALID_CREDENTIALS': {
        title: 'Invalid Credentials',
        steps: [
          'Your Account SID and Auth Token don\'t match',
          'Try copying them fresh from your Twilio Console',
          'Make sure you\'re logged into the correct Twilio account'
        ],
        link: 'https://www.twilio.com/console'
      }
    };

    // ============================================
    // Initialization
    // ============================================
    document.addEventListener('DOMContentLoaded', init);

    function init() {
      setupTabs();
      setupTemplateTabs();
      setupPlaceholderChips();
      setupColorPickers();
      setupAutoThankYouToggle();
      setupCharacterCounters();
      setupChangeTracking();
      setupInlineValidation();
      loadSettings();
    }

    // ============================================
    // Template Sub-tabs
    // ============================================
    function setupTemplateTabs() {
      document.querySelectorAll('.template-tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
          document.querySelectorAll('.template-tab').forEach(function(t) {
            t.classList.remove('active');
            t.setAttribute('aria-selected', 'false');
          });
          tab.classList.add('active');
          tab.setAttribute('aria-selected', 'true');

          document.querySelectorAll('.template-panel').forEach(function(p) {
            p.classList.remove('active');
          });
          var panelId = 'template-' + tab.dataset.template;
          document.getElementById(panelId).classList.add('active');
        });
      });
    }

    // ============================================
    // Tab Navigation
    // ============================================
    function setupTabs() {
      document.querySelectorAll('.tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
          document.querySelectorAll('.tab').forEach(function(t) {
            t.classList.remove('active');
            t.setAttribute('aria-selected', 'false');
          });
          tab.classList.add('active');
          tab.setAttribute('aria-selected', 'true');

          document.querySelectorAll('.tab-panel').forEach(function(p) {
            p.classList.remove('active');
          });
          var panelId = 'panel-' + tab.dataset.tab;
          document.getElementById(panelId).classList.add('active');
        });
      });
    }

    // ============================================
    // Advanced Options Toggle
    // ============================================
    function toggleAdvanced() {
      var toggle = document.getElementById('advancedToggle');
      var content = document.getElementById('advancedContent');
      toggle.classList.toggle('open');
      content.classList.toggle('open');
    }

    // ============================================
    // Placeholder Chip Insertion
    // ============================================
    function setupPlaceholderChips() {
      document.querySelectorAll('.chip').forEach(function(chip) {
        chip.addEventListener('click', function() {
          var targetId = chip.closest('.placeholder-chips').dataset.target;
          var textarea = document.getElementById(targetId);
          var placeholder = chip.dataset.placeholder;
          insertAtCursor(textarea, placeholder);
          updateCharacterCounter(textarea);
          markAsChanged();
        });
      });
    }

    function insertAtCursor(textarea, text) {
      var start = textarea.selectionStart;
      var end = textarea.selectionEnd;
      var before = textarea.value.substring(0, start);
      var after = textarea.value.substring(end);
      textarea.value = before + text + after;
      textarea.selectionStart = textarea.selectionEnd = start + text.length;
      textarea.focus();
    }

    // ============================================
    // Character Counters
    // ============================================
    function setupCharacterCounters() {
      var textareas = [
        { textarea: 'firstNoticeMessage', counter: 'firstNoticeCounter' },
        { textarea: 'followUpMessage', counter: 'followUpCounter' },
        { textarea: 'finalNoticeMessage', counter: 'finalNoticeCounter' },
        { textarea: 'thankYouMessage', counter: 'thankYouCounter' }
      ];

      textareas.forEach(function(item) {
        var textarea = document.getElementById(item.textarea);
        if (textarea) {
          textarea.addEventListener('input', function() {
            updateCharacterCounter(textarea);
          });
        }
      });
    }

    function updateCharacterCounter(textarea) {
      var counterMap = {
        'firstNoticeMessage': 'firstNoticeCounter',
        'followUpMessage': 'followUpCounter',
        'finalNoticeMessage': 'finalNoticeCounter',
        'thankYouMessage': 'thankYouCounter'
      };
      var counterId = counterMap[textarea.id];
      if (!counterId) return;

      var counter = document.getElementById(counterId);
      var length = textarea.value.length;
      var maxLength = 1600;
      var minLength = 50;

      counter.textContent = length + ' / ' + maxLength;
      counter.classList.remove('warning', 'error');

      if (length > maxLength) {
        counter.classList.add('error');
      } else if (length < minLength && length > 0) {
        counter.classList.add('warning');
      }
    }

    // ============================================
    // Color Pickers
    // ============================================
    function setupColorPickers() {
      var colorInputs = [
        { input: 'colorSuccess', preview: 'previewSuccess' },
        { input: 'colorError', preview: 'previewError' },
        { input: 'colorDryRun', preview: 'previewDryRun' }
      ];

      colorInputs.forEach(function(item) {
        var inputEl = document.getElementById(item.input);
        var previewEl = document.getElementById(item.preview);

        inputEl.addEventListener('input', function() {
          previewEl.style.backgroundColor = inputEl.value;
          markAsChanged();
        });
      });
    }

    function updateColorPreviews() {
      var colorInputs = [
        { input: 'colorSuccess', preview: 'previewSuccess' },
        { input: 'colorError', preview: 'previewError' },
        { input: 'colorDryRun', preview: 'previewDryRun' }
      ];

      colorInputs.forEach(function(item) {
        var inputEl = document.getElementById(item.input);
        var previewEl = document.getElementById(item.preview);
        previewEl.style.backgroundColor = inputEl.value;
      });
    }

    // ============================================
    // Auto Thank-You Toggle
    // ============================================
    function setupAutoThankYouToggle() {
      var toggle = document.getElementById('autoThankYouEnabled');
      toggle.addEventListener('change', function() {
        updateAutoThankYouUI(toggle.checked);
        markAsChanged();
      });
    }

    function updateAutoThankYouUI(isEnabled) {
      var card = document.getElementById('autoThankYouCard');
      var badge = document.getElementById('autoThankYouBadge');
      var description = document.getElementById('autoThankYouDescription');
      var feedbackBox = document.getElementById('autoThankYouFeedback');
      var feedbackText = document.getElementById('autoThankYouFeedbackText');
      var thankYouCard = document.getElementById('thankYouCard');

      if (isEnabled) {
        card.classList.add('active');
        badge.textContent = 'On';
        badge.classList.remove('warning');
        badge.style.background = '#d1fae5';
        badge.style.color = '#065f46';
        description.textContent = 'Automatically send this message when payment is marked "Paid"';
        feedbackBox.style.background = '#d1fae5';
        feedbackBox.style.borderColor = '#10b981';
        feedbackText.textContent = 'Active: This message will be sent automatically when you mark a payment as "Paid".';
        thankYouCard.style.opacity = '1';
      } else {
        card.classList.remove('active');
        badge.textContent = 'Off';
        badge.classList.add('warning');
        badge.style.background = '#fef3c7';
        badge.style.color = '#92400e';
        description.textContent = 'Auto-send is OFF - messages will NOT be sent automatically';
        feedbackBox.style.background = '#fef3c7';
        feedbackBox.style.borderColor = '#f59e0b';
        feedbackText.textContent = 'Disabled: Customers will NOT receive automatic thank-you messages when marked as paid.';
        thankYouCard.style.opacity = '0.7';
      }
    }

    // ============================================
    // Change Tracking
    // ============================================
    function setupChangeTracking() {
      document.querySelectorAll('input, textarea, select').forEach(function(el) {
        el.addEventListener('input', markAsChanged);
        el.addEventListener('change', markAsChanged);
      });
    }

    function markAsChanged() {
      if (!hasUnsavedChanges) {
        hasUnsavedChanges = true;
        document.getElementById('unsavedBadge').classList.add('visible');
      }
    }

    function clearChanges() {
      hasUnsavedChanges = false;
      document.getElementById('unsavedBadge').classList.remove('visible');
    }

    // ============================================
    // Settings Load/Save
    // ============================================
    function loadSettings() {
      showLoading(true);
      google.script.run
        .withSuccessHandler(onSettingsLoaded)
        .withFailureHandler(onError)
        .getSettingsForUI();
    }

    function onSettingsLoaded(data) {
      currentSettings = data.settings;
      originalSettings = JSON.parse(JSON.stringify(data.settings));
      sheetHeaders = data.headers || [];

      // Check for first-time setup
      if (data.isFirstTime) {
        isFirstTimeUser = true;
        showWizard();
      }

      // Business tab
      document.getElementById('businessName').value = currentSettings.business.name || '';
      document.getElementById('etransferEmail').value = currentSettings.business.etransferEmail || '';
      document.getElementById('phoneNumber').value = currentSettings.business.phoneNumber || '';
      document.getElementById('whatsappLink').value = currentSettings.business.whatsappLink || '';

      // Templates tab - Bill Messages
      var billTemplates = currentSettings.templates.billMessages || {};

      document.getElementById('firstNoticeName').value = (billTemplates.firstNotice && billTemplates.firstNotice.name) || 'First Notice';
      document.getElementById('firstNoticeMessage').value = (billTemplates.firstNotice && billTemplates.firstNotice.message) || '';
      updateCharacterCounter(document.getElementById('firstNoticeMessage'));

      document.getElementById('followUpName').value = (billTemplates.followUp && billTemplates.followUp.name) || 'Follow-up Reminder';
      document.getElementById('followUpMessage').value = (billTemplates.followUp && billTemplates.followUp.message) || '';
      updateCharacterCounter(document.getElementById('followUpMessage'));

      document.getElementById('finalNoticeName').value = (billTemplates.finalNotice && billTemplates.finalNotice.name) || 'Final Notice';
      document.getElementById('finalNoticeMessage').value = (billTemplates.finalNotice && billTemplates.finalNotice.message) || '';
      updateCharacterCounter(document.getElementById('finalNoticeMessage'));

      document.getElementById('thankYouMessage').value = currentSettings.templates.thankYouMessage || '';
      updateCharacterCounter(document.getElementById('thankYouMessage'));

      // Behavior tab
      document.getElementById('testOrderId').value = currentSettings.behavior.testOrderId || '';

      var autoThankYouToggle = document.getElementById('autoThankYouEnabled');
      autoThankYouToggle.checked = currentSettings.behavior.autoThankYouEnabled !== false;
      updateAutoThankYouUI(autoThankYouToggle.checked);

      document.getElementById('batchSize').value = currentSettings.behavior.batchSize;
      document.getElementById('messageDelayMs').value = currentSettings.behavior.messageDelayMs;
      document.getElementById('headerRowIndex').value = currentSettings.behavior.headerRowIndex;

      // Colors tab
      document.getElementById('colorSuccess').value = currentSettings.colors.success;
      document.getElementById('colorError').value = currentSettings.colors.error;
      document.getElementById('colorDryRun').value = currentSettings.colors.dryRun;
      updateColorPreviews();

      // Twilio credentials (masked)
      if (data.credentials) {
        populateCredentialFields(data.credentials);
      }

      // Columns tab
      populateColumnSelects();

      showLoading(false);
      clearChanges();
    }

    function populateColumnSelects() {
      var selects = {
        colPhoneNumber: currentSettings.columns.phoneNumber,
        colCustomerName: currentSettings.columns.customerName,
        colBalance: currentSettings.columns.balance,
        colNumTiffins: currentSettings.columns.numTiffins,
        colDueDate: currentSettings.columns.dueDate,
        colMessageStatus: currentSettings.columns.messageStatus,
        colOrderId: currentSettings.columns.orderId,
        colPaymentStatus: currentSettings.columns.paymentStatus
      };

      Object.keys(selects).forEach(function(selectId) {
        var currentValue = selects[selectId];
        var select = document.getElementById(selectId);

        while (select.firstChild) {
          select.removeChild(select.firstChild);
        }

        var defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '-- Choose a column --';
        select.appendChild(defaultOption);

        sheetHeaders.forEach(function(header) {
          var option = document.createElement('option');
          option.value = header;
          option.textContent = header;
          if (header === currentValue) {
            option.selected = true;
          }
          select.appendChild(option);
        });

        if (currentValue && sheetHeaders.indexOf(currentValue) === -1) {
          var customOption = document.createElement('option');
          customOption.value = currentValue;
          customOption.textContent = currentValue + ' (not found in sheet)';
          customOption.selected = true;
          select.appendChild(customOption);
        }
      });
    }

    function refreshHeaders() {
      showLoading(true);
      google.script.run
        .withSuccessHandler(function(headers) {
          sheetHeaders = headers;
          populateColumnSelects();
          showLoading(false);
          showToast('Column list refreshed!', 'success');
        })
        .withFailureHandler(onError)
        .getSheetHeaders();
    }

    function collectFormData() {
      return {
        version: currentSettings.version,
        business: {
          name: document.getElementById('businessName').value.trim(),
          etransferEmail: document.getElementById('etransferEmail').value.trim(),
          phoneNumber: document.getElementById('phoneNumber').value.trim(),
          whatsappLink: document.getElementById('whatsappLink').value.trim()
        },
        templates: {
          billMessages: {
            firstNotice: {
              name: document.getElementById('firstNoticeName').value.trim() || 'First Notice',
              message: document.getElementById('firstNoticeMessage').value
            },
            followUp: {
              name: document.getElementById('followUpName').value.trim() || 'Follow-up Reminder',
              message: document.getElementById('followUpMessage').value
            },
            finalNotice: {
              name: document.getElementById('finalNoticeName').value.trim() || 'Final Notice',
              message: document.getElementById('finalNoticeMessage').value
            }
          },
          thankYouMessage: document.getElementById('thankYouMessage').value
        },
        behavior: {
          autoThankYouEnabled: document.getElementById('autoThankYouEnabled').checked,
          batchSize: parseInt(document.getElementById('batchSize').value, 10),
          messageDelayMs: parseInt(document.getElementById('messageDelayMs').value, 10),
          headerRowIndex: parseInt(document.getElementById('headerRowIndex').value, 10),
          testOrderId: document.getElementById('testOrderId').value.trim()
        },
        colors: {
          success: document.getElementById('colorSuccess').value,
          error: document.getElementById('colorError').value,
          dryRun: document.getElementById('colorDryRun').value
        },
        columns: {
          phoneNumber: document.getElementById('colPhoneNumber').value,
          customerName: document.getElementById('colCustomerName').value,
          balance: document.getElementById('colBalance').value,
          numTiffins: document.getElementById('colNumTiffins').value,
          dueDate: document.getElementById('colDueDate').value,
          messageStatus: document.getElementById('colMessageStatus').value,
          orderId: document.getElementById('colOrderId').value,
          paymentStatus: document.getElementById('colPaymentStatus').value
        }
      };
    }

    function saveSettingsUI() {
      var settings = collectFormData();
      showLoading(true);

      google.script.run
        .withSuccessHandler(function(result) {
          showLoading(false);
          if (result.success) {
            currentSettings = settings;
            originalSettings = JSON.parse(JSON.stringify(settings));
            clearChanges();
            if (result.warning) {
              showToast(result.warning, 'warning');
            } else {
              showToast('Settings saved!', 'success');
            }
          } else {
            showToast('Could not save: ' + result.error, 'error');
          }
        })
        .withFailureHandler(onError)
        .saveSettingsFromUI(settings);
    }

    function confirmReset() {
      showConfirm({
        title: 'Reset Settings',
        message: 'Are you sure you want to reset ALL settings back to the original defaults? This cannot be undone!',
        confirmLabel: 'Reset All',
        destructive: true
      }).then(function(ok) {
        if (!ok) return;
        showLoading(true);
        google.script.run
          .withSuccessHandler(function() {
            loadSettings();
            showToast('Settings have been reset to defaults', 'success');
          })
          .withFailureHandler(onError)
          .resetToDefaults();
      });
    }

    function exportSettingsUI() {
      var settings = collectFormData();
      var json = JSON.stringify(settings, null, 2);
      var blob = new Blob([json], { type: 'application/json' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'billing-settings-backup.json';
      a.click();
      URL.revokeObjectURL(url);
      showToast('Settings backed up to file!', 'success');
    }

    function importSettingsUI() {
      var input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = function(e) {
        var file = e.target.files[0];
        if (!file) return;

        var reader = new FileReader();
        reader.onload = function(event) {
          try {
            JSON.parse(event.target.result);
            showLoading(true);
            google.script.run
              .withSuccessHandler(function(result) {
                if (result.success) {
                  loadSettings();
                  showToast('Settings restored from backup!', 'success');
                } else {
                  showLoading(false);
                  showToast('Could not restore: ' + result.error, 'error');
                }
              })
              .withFailureHandler(onError)
              .importSettings(event.target.result);
          } catch (err) {
            showToast('This file is not a valid settings backup', 'error');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    function previewTemplate(type) {
      var templateFieldMap = {
        'firstNotice': 'firstNoticeMessage',
        'followUp': 'followUpMessage',
        'finalNotice': 'finalNoticeMessage',
        'thankYou': 'thankYouMessage'
      };
      var previewDivMap = {
        'firstNotice': 'firstNoticePreview',
        'followUp': 'followUpPreview',
        'finalNotice': 'finalNoticePreview',
        'thankYou': 'thankYouPreview'
      };

      var template = document.getElementById(templateFieldMap[type]).value;

      google.script.run
        .withSuccessHandler(function(preview) {
          var container = document.getElementById(previewDivMap[type]);
          container.classList.remove('hidden');
          container.querySelector('.preview-content').textContent = preview;
        })
        .withFailureHandler(onError)
        .previewTemplate(template);
    }

    // ============================================
    // UI Helpers
    // ============================================
    function showLoading(show) {
      var overlay = document.getElementById('loading');
      if (show) {
        overlay.classList.remove('hidden');
      } else {
        overlay.classList.add('hidden');
      }
    }

    function onError(error) {
      showLoading(false);
      showToast(error.message || 'Something went wrong. Please try again.', 'error');
      console.error(error);
    }

    // ============================================
    // Inline Validation
    // ============================================
    function setupInlineValidation() {
      // Business tab fields
      var businessFields = [
        { id: 'businessName', rule: 'required' },
        { id: 'etransferEmail', rule: 'email' },
        { id: 'phoneNumber', rule: 'phone' }
      ];

      businessFields.forEach(function(field) {
        var input = document.getElementById(field.id);
        if (input) {
          input.addEventListener('blur', function() {
            validateField(input, field.rule);
          });
          input.addEventListener('input', function() {
            clearFieldValidation(input);
          });
        }
      });

      // Color fields
      var colorFields = ['colorSuccess', 'colorError', 'colorDryRun'];
      colorFields.forEach(function(fieldId) {
        var input = document.getElementById(fieldId);
        if (input) {
          input.addEventListener('change', function() {
            validateField(input, 'hexColor');
          });
        }
      });
    }

    function validateField(input, ruleName) {
      var value = input.value.trim();
      var rule = validationRules[ruleName];

      if (!rule) return true;

      if (!value && ruleName !== 'required') {
        clearFieldValidation(input);
        return true;
      }

      var isValid = false;
      if (rule.pattern) {
        isValid = rule.pattern.test(value);
      } else if (rule.min !== undefined) {
        isValid = value.length >= rule.min && value.length <= rule.max;
      }

      if (isValid) {
        setFieldValidationState(input, 'success', 'Looks good!', '');
        setTimeout(function() {
          clearFieldValidation(input);
        }, 2000);
      } else {
        setFieldValidationState(input, 'error', rule.message, rule.example);
      }

      return isValid;
    }

    function setFieldValidationState(input, type, message, hint) {
      input.classList.remove('valid', 'invalid');
      input.classList.add(type === 'success' ? 'valid' : 'invalid');

      var validationId = input.id + 'Validation';
      var validationEl = document.getElementById(validationId);

      if (!validationEl) {
        validationEl = document.createElement('div');
        validationEl.id = validationId;
        validationEl.className = 'field-validation';
        input.parentNode.insertBefore(validationEl, input.nextSibling);
      }

      validationEl.className = 'field-validation ' + type;
      validationEl.textContent = '';

      // Build content safely using DOM methods
      var icon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      icon.setAttribute('class', 'field-validation-icon');
      icon.setAttribute('viewBox', '0 0 24 24');
      icon.setAttribute('fill', 'none');
      icon.setAttribute('stroke', 'currentColor');
      icon.setAttribute('stroke-width', '2');

      if (type === 'success') {
        var path1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path1.setAttribute('d', 'M22 11.08V12a10 10 0 1 1-5.93-9.14');
        var polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
        polyline.setAttribute('points', '22 4 12 14.01 9 11.01');
        icon.appendChild(path1);
        icon.appendChild(polyline);
      } else {
        var circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', '12');
        circle.setAttribute('cy', '12');
        circle.setAttribute('r', '10');
        var line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line1.setAttribute('x1', '15');
        line1.setAttribute('y1', '9');
        line1.setAttribute('x2', '9');
        line1.setAttribute('y2', '15');
        var line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line2.setAttribute('x1', '9');
        line2.setAttribute('y1', '9');
        line2.setAttribute('x2', '15');
        line2.setAttribute('y2', '15');
        icon.appendChild(circle);
        icon.appendChild(line1);
        icon.appendChild(line2);
      }

      var contentDiv = document.createElement('div');
      contentDiv.className = 'field-validation-content';
      contentDiv.textContent = message;

      if (hint) {
        var hintDiv = document.createElement('div');
        hintDiv.style.fontSize = '12px';
        hintDiv.style.opacity = '0.9';
        hintDiv.style.marginTop = '2px';
        hintDiv.textContent = hint;
        contentDiv.appendChild(hintDiv);
      }

      validationEl.appendChild(icon);
      validationEl.appendChild(contentDiv);
      validationEl.classList.remove('hidden');
    }

    function clearFieldValidation(input) {
      input.classList.remove('valid', 'invalid');
      var validationId = input.id + 'Validation';
      var validationEl = document.getElementById(validationId);
      if (validationEl) {
        validationEl.classList.add('hidden');
      }
    }

    function validateAllFields() {
      var errors = [];

      var businessName = document.getElementById('businessName');
      var etransferEmail = document.getElementById('etransferEmail');
      var phoneNumber = document.getElementById('phoneNumber');

      if (!validateField(businessName, 'required')) {
        errors.push({ field: 'businessName', tab: 'business', message: 'Business name is required' });
      }
      if (!validateField(etransferEmail, 'email')) {
        errors.push({ field: 'etransferEmail', tab: 'business', message: 'Valid payment email is required' });
      }
      if (!validateField(phoneNumber, 'phone')) {
        errors.push({ field: 'phoneNumber', tab: 'business', message: 'Valid phone number is required' });
      }

      var templates = ['firstNoticeMessage', 'followUpMessage', 'finalNoticeMessage', 'thankYouMessage'];
      templates.forEach(function(fieldId) {
        var field = document.getElementById(fieldId);
        if (field && (field.value.length < 50 || field.value.length > 1600)) {
          errors.push({
            field: fieldId,
            tab: 'templates',
            message: fieldId.replace('Message', '') + ' must be 50-1600 characters'
          });
        }
      });

      var columnFields = ['colPhoneNumber', 'colCustomerName', 'colBalance', 'colNumTiffins',
                          'colDueDate', 'colMessageStatus', 'colOrderId', 'colPaymentStatus'];
      columnFields.forEach(function(fieldId) {
        var field = document.getElementById(fieldId);
        if (field && !field.value) {
          errors.push({
            field: fieldId,
            tab: 'columns',
            message: fieldId.replace('col', '') + ' column is required'
          });
        }
      });

      return errors;
    }

    function showErrorSummary(errors) {
      var existing = document.querySelector('.error-summary');
      if (existing) existing.remove();

      if (errors.length === 0) return;

      var summary = document.createElement('div');
      summary.className = 'error-summary';

      var titleDiv = document.createElement('div');
      titleDiv.className = 'error-summary-title';

      var titleIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      titleIcon.setAttribute('width', '20');
      titleIcon.setAttribute('height', '20');
      titleIcon.setAttribute('viewBox', '0 0 24 24');
      titleIcon.setAttribute('fill', 'none');
      titleIcon.setAttribute('stroke', 'currentColor');
      titleIcon.setAttribute('stroke-width', '2');
      var circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      circle.setAttribute('cx', '12');
      circle.setAttribute('cy', '12');
      circle.setAttribute('r', '10');
      var line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line1.setAttribute('x1', '15');
      line1.setAttribute('y1', '9');
      line1.setAttribute('x2', '9');
      line1.setAttribute('y2', '15');
      var line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line2.setAttribute('x1', '9');
      line2.setAttribute('y1', '9');
      line2.setAttribute('x2', '15');
      line2.setAttribute('y2', '15');
      titleIcon.appendChild(circle);
      titleIcon.appendChild(line1);
      titleIcon.appendChild(line2);

      titleDiv.appendChild(titleIcon);
      var titleText = document.createTextNode('Please fix ' + errors.length + ' error' + (errors.length > 1 ? 's' : '') + ' before saving');
      titleDiv.appendChild(titleText);

      var list = document.createElement('ul');
      list.className = 'error-summary-list';

      errors.forEach(function(error) {
        var item = document.createElement('li');
        item.className = 'error-summary-item';
        item.textContent = error.message + ' (click to fix)';
        item.addEventListener('click', function() {
          goToError(error.field, error.tab);
        });
        list.appendChild(item);
      });

      summary.appendChild(titleDiv);
      summary.appendChild(list);

      var content = document.querySelector('.content');
      content.insertBefore(summary, content.firstChild);
      summary.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function goToError(fieldId, tabName) {
      var tab = document.querySelector('[data-tab="' + tabName + '"]');
      if (tab) tab.click();

      setTimeout(function() {
        var field = document.getElementById(fieldId);
        if (field) {
          field.focus();
          field.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }, 100);
    }

    // ============================================
    // Onboarding Wizard
    // ============================================
    function checkFirstTimeSetup() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.isFirstTime) {
            isFirstTimeUser = true;
            showWizard();
          }
        })
        .withFailureHandler(function() {
          console.log('First-time check failed, proceeding normally');
        })
        .isFirstTimeSetup();
    }

    function showWizard() {
      document.getElementById('wizardOverlay').classList.remove('hidden');
      wizardStep = 1;
      updateWizardUI();
    }

    function hideWizard() {
      document.getElementById('wizardOverlay').classList.add('hidden');
    }

    function skipWizard() {
      showConfirm({
        title: 'Skip Setup',
        message: 'Are you sure you want to skip the setup wizard? You can configure settings manually using the Credentials menu and Settings dialog.',
        confirmLabel: 'Skip'
      }).then(function(ok) {
        if (!ok) return;
        hideWizard();
        google.script.run.markSetupSkipped();
      });
    }

    function updateWizardUI() {
      var progress = (wizardStep / 4) * 100;
      document.getElementById('wizardProgressFill').style.width = progress + '%';

      document.querySelectorAll('.wizard-step').forEach(function(step) {
        var stepNum = parseInt(step.dataset.step);
        step.classList.remove('active', 'completed');
        if (stepNum < wizardStep) {
          step.classList.add('completed');
        } else if (stepNum === wizardStep) {
          step.classList.add('active');
        }
      });

      for (var i = 1; i <= 4; i++) {
        var panel = document.getElementById('wizardStep' + i);
        if (panel) {
          panel.classList.toggle('active', i === wizardStep);
        }
      }

      document.getElementById('wizardBackBtn').style.display = wizardStep > 1 ? 'inline-flex' : 'none';
      document.getElementById('wizardSkipBtn').style.display = wizardStep === 1 ? 'inline-flex' : 'none';
      document.getElementById('wizardTestBtn').style.display = wizardStep === 1 ? 'inline-flex' : 'none';

      var nextBtn = document.getElementById('wizardNextBtn');
      if (wizardStep === 4) {
        nextBtn.textContent = 'Complete Setup';
      } else {
        nextBtn.textContent = 'Next Step';
      }

      if (wizardStep === 3) {
        wizardLoadColumns();
      } else if (wizardStep === 4) {
        wizardUpdateSummary();
      }
    }

    function wizardBack() {
      if (wizardStep > 1) {
        wizardStep--;
        updateWizardUI();
      }
    }

    function wizardNext() {
      Promise.resolve(validateWizardStep(wizardStep)).then(function(valid) {
        if (!valid) return;
        saveWizardStepData(wizardStep);
        if (wizardStep < 4) {
          wizardStep++;
          updateWizardUI();
        } else {
          completeWizardSetup();
        }
      });
    }

    function validateWizardStep(step) {
      switch (step) {
        case 1:
          var accountSid = document.getElementById('wizardAccountSid').value.trim();
          var authToken = document.getElementById('wizardAuthToken').value.trim();
          var twilioPhone = document.getElementById('wizardTwilioPhone').value.trim();

          var hasErrors = false;

          if (!accountSid || !/^AC[a-f0-9]{32}$/i.test(accountSid)) {
            setWizardFieldState('wizardAccountSid', 'error', 'Account SID should start with "AC" and be 34 characters');
            hasErrors = true;
          }
          if (!authToken || !/^[a-f0-9]{32}$/i.test(authToken)) {
            setWizardFieldState('wizardAuthToken', 'error', 'Auth Token should be 32 characters');
            hasErrors = true;
          }
          if (!twilioPhone) {
            setWizardFieldState('wizardTwilioPhone', 'error', 'Phone number is required');
            hasErrors = true;
          }

          if (hasErrors) {
            showToast('Please fix the errors above before continuing', 'error');
            return false;
          }

          if (!wizardData.credentialsValid) {
            return showConfirm({
              title: 'Continue Without Testing?',
              message: 'You haven\'t tested your Twilio credentials yet. Continue anyway?',
              confirmLabel: 'Continue Anyway'
            });
          }
          return true;

        case 2:
          var businessName = document.getElementById('wizardBusinessName').value.trim();
          var etransferEmail = document.getElementById('wizardEtransferEmail').value.trim();
          var phoneNumber = document.getElementById('wizardPhoneNumber').value.trim();

          var hasErrors = false;

          if (!businessName) {
            setWizardFieldState('wizardBusinessName', 'error', 'Business name is required');
            hasErrors = true;
          }
          if (!etransferEmail || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(etransferEmail)) {
            setWizardFieldState('wizardEtransferEmail', 'error', 'Valid email is required');
            hasErrors = true;
          }
          if (!phoneNumber) {
            setWizardFieldState('wizardPhoneNumber', 'error', 'Phone number is required');
            hasErrors = true;
          }

          if (hasErrors) {
            showToast('Please fix the errors above before continuing', 'error');
            return false;
          }
          return true;

        case 3:
          var requiredColumns = ['phoneNumber', 'customerName', 'balance', 'paymentStatus'];
          var missingColumns = [];

          requiredColumns.forEach(function(col) {
            if (!wizardData.columns[col]) {
              missingColumns.push(col);
            }
          });

          if (missingColumns.length > 0) {
            showToast('Please select columns for: ' + missingColumns.join(', '), 'error');
            return false;
          }
          return true;

        default:
          return true;
      }
    }

    function setWizardFieldState(fieldId, type, message) {
      var input = document.getElementById(fieldId);
      var validationEl = document.getElementById(fieldId + 'Validation');

      if (input) {
        input.classList.remove('valid', 'invalid');
        input.classList.add(type === 'success' ? 'valid' : 'invalid');
      }

      if (validationEl) {
        validationEl.className = 'field-validation ' + type;
        validationEl.textContent = message;
        validationEl.classList.remove('hidden');
      }
    }

    function saveWizardStepData(step) {
      switch (step) {
        case 1:
          wizardData.accountSid = document.getElementById('wizardAccountSid').value.trim();
          wizardData.authToken = document.getElementById('wizardAuthToken').value.trim();
          wizardData.twilioPhone = document.getElementById('wizardTwilioPhone').value.trim();
          break;
        case 2:
          wizardData.businessName = document.getElementById('wizardBusinessName').value.trim();
          wizardData.etransferEmail = document.getElementById('wizardEtransferEmail').value.trim();
          wizardData.phoneNumber = document.getElementById('wizardPhoneNumber').value.trim();
          wizardData.whatsappLink = document.getElementById('wizardWhatsappLink').value.trim();
          break;
      }
    }

    function wizardTestCredentials() {
      var accountSid = document.getElementById('wizardAccountSid').value.trim();
      var authToken = document.getElementById('wizardAuthToken').value.trim();
      var twilioPhone = document.getElementById('wizardTwilioPhone').value.trim();

      if (!accountSid || !authToken) {
        showToast('Please enter your Account SID and Auth Token first', 'error');
        return;
      }

      var statusEl = document.getElementById('wizardCredentialStatus');
      statusEl.className = 'credential-test-status testing';
      statusEl.textContent = 'Testing connection...';

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            statusEl.className = 'credential-test-status success';
            statusEl.textContent = 'Connection successful! ' + (result.accountName || '');
            wizardData.credentialsValid = true;
            showToast('Twilio credentials verified!', 'success');
          } else {
            statusEl.className = 'credential-test-status error';
            statusEl.textContent = 'Connection failed: ' + result.error;
            wizardData.credentialsValid = false;
          }
        })
        .withFailureHandler(function(error) {
          statusEl.className = 'credential-test-status error';
          statusEl.textContent = 'Connection test failed: ' + (error.message || 'Unknown error');
          wizardData.credentialsValid = false;
        })
        .testTwilioCredentials(accountSid, authToken, twilioPhone);
    }

    function wizardLoadColumns() {
      var statusEl = document.getElementById('wizardColumnStatus');
      var containerEl = document.getElementById('wizardColumnsContainer');
      var emptyEl = document.getElementById('wizardColumnsEmpty');

      statusEl.classList.remove('hidden');
      statusEl.className = 'credential-test-status testing';
      statusEl.textContent = 'Analyzing your spreadsheet...';

      google.script.run
        .withSuccessHandler(function(result) {
          statusEl.classList.add('hidden');

          if (!result.headers || result.headers.length === 0) {
            containerEl.classList.add('hidden');
            emptyEl.classList.remove('hidden');
            return;
          }

          emptyEl.classList.add('hidden');
          containerEl.classList.remove('hidden');

          wizardData.columnDetections = result.detections || {};
          buildWizardColumnUI(result.headers, result.detections);
        })
        .withFailureHandler(function(error) {
          statusEl.className = 'credential-test-status error';
          statusEl.textContent = 'Could not read spreadsheet: ' + (error.message || 'Unknown error');
        })
        .autoDetectColumns();
    }

    function buildWizardColumnUI(headers, detections) {
      var containerEl = document.getElementById('wizardColumnsContainer');
      containerEl.textContent = '';

      var columnDefs = [
        { id: 'phoneNumber', label: 'Customer Phone Number' },
        { id: 'customerName', label: 'Customer Name' },
        { id: 'balance', label: 'Amount Owed' },
        { id: 'numTiffins', label: 'Number of Tiffins' },
        { id: 'dueDate', label: 'Due Date / Month' },
        { id: 'messageStatus', label: 'Message Status' },
        { id: 'orderId', label: 'Order ID' },
        { id: 'paymentStatus', label: 'Payment Status' }
      ];

      var grid = document.createElement('div');
      grid.className = 'form-grid';

      columnDefs.forEach(function(col) {
        var detection = detections[col.id];
        var selectedValue = detection ? detection.match : '';
        var confidence = detection ? detection.confidence : 0;

        var confidenceClass = 'low';
        var confidenceLabel = 'Not found';
        if (confidence >= 90) {
          confidenceClass = 'high';
          confidenceLabel = 'Auto-detected';
        } else if (confidence >= 70) {
          confidenceClass = 'medium';
          confidenceLabel = 'Please verify';
        }

        if (selectedValue) {
          wizardData.columns[col.id] = selectedValue;
        }

        var group = document.createElement('div');
        group.className = 'form-group';

        var label = document.createElement('label');
        label.className = 'form-label';
        label.setAttribute('for', 'wizardCol' + col.id);
        label.textContent = col.label + ' ';

        if (confidence > 0) {
          var badge = document.createElement('span');
          badge.className = 'column-detect-status ' + confidenceClass;
          badge.textContent = confidenceLabel;
          label.appendChild(badge);
        }

        var select = document.createElement('select');
        select.className = 'form-select';
        select.id = 'wizardCol' + col.id;

        var defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '-- Choose a column --';
        select.appendChild(defaultOption);

        headers.forEach(function(header) {
          var option = document.createElement('option');
          option.value = header;
          option.textContent = header;
          if (header === selectedValue) {
            option.selected = true;
          }
          select.appendChild(option);
        });

        select.addEventListener('change', function() {
          wizardData.columns[col.id] = this.value;
        });

        group.appendChild(label);
        group.appendChild(select);
        grid.appendChild(group);
      });

      containerEl.appendChild(grid);
    }

    function wizardRefreshColumns() {
      wizardLoadColumns();
    }

    function wizardUpdateSummary() {
      document.getElementById('wizardSummaryTwilioStatus').textContent = wizardData.credentialsValid ? 'Connected' : 'Not Tested';
      document.getElementById('wizardSummaryTwilioStatus').className = 'summary-value ' + (wizardData.credentialsValid ? 'success' : 'warning');
      document.getElementById('wizardSummaryTwilioPhone').textContent = wizardData.twilioPhone || 'Not set';

      document.getElementById('wizardSummaryBusinessName').textContent = wizardData.businessName || 'Not set';
      document.getElementById('wizardSummaryEmail').textContent = wizardData.etransferEmail || 'Not set';

      var columnsContainer = document.getElementById('wizardSummaryColumns');
      columnsContainer.textContent = '';

      var columnLabels = {
        phoneNumber: 'Phone',
        customerName: 'Name',
        balance: 'Balance',
        numTiffins: 'Tiffins',
        dueDate: 'Due Date',
        messageStatus: 'Status',
        orderId: 'Order ID',
        paymentStatus: 'Payment'
      };

      Object.keys(columnLabels).forEach(function(key) {
        var value = wizardData.columns[key];

        var item = document.createElement('div');
        item.className = 'summary-item';

        var labelSpan = document.createElement('span');
        labelSpan.className = 'summary-label';
        labelSpan.textContent = columnLabels[key];

        var valueSpan = document.createElement('span');
        valueSpan.className = 'summary-value';
        valueSpan.textContent = value || 'Not set';
        if (!value) {
          valueSpan.style.color = 'var(--color-text-muted)';
        }

        item.appendChild(labelSpan);
        item.appendChild(valueSpan);
        columnsContainer.appendChild(item);
      });
    }

    function completeWizardSetup() {
      showLoading(true);

      var setupData = {
        credentials: {
          accountSid: wizardData.accountSid,
          authToken: wizardData.authToken,
          twilioPhone: wizardData.twilioPhone
        },
        business: {
          name: wizardData.businessName,
          etransferEmail: wizardData.etransferEmail,
          phoneNumber: wizardData.phoneNumber,
          whatsappLink: wizardData.whatsappLink
        },
        columns: wizardData.columns
      };

      google.script.run
        .withSuccessHandler(function(result) {
          showLoading(false);
          if (result.success) {
            hideWizard();
            loadSettings();
            showToast('Setup complete! Your billing system is ready.', 'success');
          } else {
            showToast('Setup failed: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          showToast('Setup failed: ' + (error.message || 'Unknown error'), 'error');
        })
        .completeFirstTimeSetup(setupData);
    }

    // ============================================
    // Twilio Credentials (Advanced Settings)
    // ============================================

    // Track whether credential fields were changed from masked placeholders
    var credentialMasks = { sid: '', phone: '' };

    function populateCredentialFields(creds) {
      var statusEl = document.getElementById('advTwilioStatus');
      var statusText = document.getElementById('advTwilioStatusText');

      if (creds.hasAccountSid) {
        document.getElementById('advAccountSid').value = creds.maskedSid || '';
        credentialMasks.sid = creds.maskedSid || '';
      }
      if (creds.hasPhoneNumber) {
        document.getElementById('advTwilioPhone').value = creds.maskedPhone || '';
        credentialMasks.phone = creds.maskedPhone || '';
      }
      if (creds.hasAuthToken) {
        document.getElementById('advAuthToken').placeholder = 'Token is set (enter new to change)';
      }

      if (creds.hasAccountSid && creds.hasAuthToken && creds.hasPhoneNumber) {
        statusEl.className = 'credential-inline-status connected';
        statusText.textContent = 'All credentials configured';
      } else if (creds.hasAccountSid || creds.hasAuthToken || creds.hasPhoneNumber) {
        statusEl.className = 'credential-inline-status not-set';
        statusText.textContent = 'Partially configured';
      } else {
        statusEl.className = 'credential-inline-status not-set';
        statusText.textContent = 'Not configured';
      }
    }

    function getCredentialChanges() {
      var sid = document.getElementById('advAccountSid').value.trim();
      var token = document.getElementById('advAuthToken').value.trim();
      var phone = document.getElementById('advTwilioPhone').value.trim();
      var changes = {};

      // Only include values that were actually changed (not masked placeholders)
      if (sid && sid !== credentialMasks.sid) changes.accountSid = sid;
      if (token) changes.authToken = token;
      if (phone && phone !== credentialMasks.phone) changes.twilioPhone = phone;

      return changes;
    }

    function toggleTokenVisibility() {
      var input = document.getElementById('advAuthToken');
      var isPassword = input.type === 'password';
      input.type = isPassword ? 'text' : 'password';
      // Swap the eye icon SVG content
      var icon = document.getElementById('tokenEyeIcon');
      while (icon.firstChild) icon.removeChild(icon.firstChild);
      if (isPassword) {
        // Eye-off icon (slash through eye)
        var path1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path1.setAttribute('d', 'M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24');
        var line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line1.setAttribute('x1', '1'); line1.setAttribute('y1', '1');
        line1.setAttribute('x2', '23'); line1.setAttribute('y2', '23');
        icon.appendChild(path1);
        icon.appendChild(line1);
      } else {
        // Eye icon (open)
        var path2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path2.setAttribute('d', 'M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z');
        var circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', '12'); circle.setAttribute('cy', '12'); circle.setAttribute('r', '3');
        icon.appendChild(path2);
        icon.appendChild(circle);
      }
    }

    function testTwilioFromAdvanced() {
      var btn = document.getElementById('advTestTwilioBtn');
      var statusEl = document.getElementById('advTwilioStatus');
      var statusText = document.getElementById('advTwilioStatusText');

      btn.disabled = true;
      statusEl.className = 'credential-inline-status testing';
      statusText.textContent = 'Testing...';

      // If user entered new credentials, test those; otherwise test stored
      var changes = getCredentialChanges();
      if (changes.accountSid && changes.authToken) {
        google.script.run
          .withSuccessHandler(function(result) { handleTestResult(result, btn, statusEl, statusText); })
          .withFailureHandler(function(error) { handleTestError(error, btn, statusEl, statusText); })
          .testTwilioCredentials(changes.accountSid, changes.authToken, changes.twilioPhone || '');
      } else {
        google.script.run
          .withSuccessHandler(function(result) { handleTestResult(result, btn, statusEl, statusText); })
          .withFailureHandler(function(error) { handleTestError(error, btn, statusEl, statusText); })
          .testTwilioCredentialsFromSettings();
      }
    }

    function handleTestResult(result, btn, statusEl, statusText) {
      btn.disabled = false;
      if (result.success) {
        statusEl.className = 'credential-inline-status connected';
        statusText.textContent = result.accountName || 'Connected';
        showToast('Twilio connection verified!', 'success');
      } else {
        statusEl.className = 'credential-inline-status error';
        statusText.textContent = result.error || 'Connection failed';
      }
    }

    function handleTestError(error, btn, statusEl, statusText) {
      btn.disabled = false;
      statusEl.className = 'credential-inline-status error';
      statusText.textContent = error.message || 'Test failed';
    }

    // Override save to include validation + credential saving
    var originalSaveSettingsUI = saveSettingsUI;
    saveSettingsUI = function() {
      var errors = validateAllFields();

      if (errors.length > 0) {
        showErrorSummary(errors);
        return;
      }

      var existingSummary = document.querySelector('.error-summary');
      if (existingSummary) existingSummary.remove();

      var settings = collectFormData();
      var credChanges = getCredentialChanges();
      var hasCredChanges = Object.keys(credChanges).length > 0;

      showLoading(true);

      // Save credentials first if changed, then save settings
      if (hasCredChanges) {
        google.script.run
          .withSuccessHandler(function() {
            // Now save the rest of the settings
            saveMainSettings(settings);
          })
          .withFailureHandler(function(error) {
            showLoading(false);
            showToast('Could not save credentials: ' + (error.message || 'Unknown error'), 'error');
          })
          .saveTwilioCredentialsFromUI(credChanges);
      } else {
        saveMainSettings(settings);
      }
    };

    function saveMainSettings(settings) {
      google.script.run
        .withSuccessHandler(function(result) {
          showLoading(false);
          if (result.success) {
            currentSettings = settings;
            originalSettings = JSON.parse(JSON.stringify(settings));
            clearChanges();
            // Update masked credential values after save
            var credChanges = getCredentialChanges();
            if (credChanges.accountSid) credentialMasks.sid = credChanges.accountSid.substring(0, 6) + '...' + credChanges.accountSid.substring(credChanges.accountSid.length - 4);
            if (credChanges.twilioPhone) credentialMasks.phone = '***' + credChanges.twilioPhone.slice(-4);
            if (result.warning) {
              showToast(result.warning, 'warning');
            } else {
              showToast('Settings saved!', 'success');
            }
          } else {
            showToast('Could not save: ' + result.error, 'error');
          }
        })
        .withFailureHandler(onError)
        .saveSettingsFromUI(settings);
    }
  </script>
  <?!= include('shared-utils') ?>
</body>
</html>
