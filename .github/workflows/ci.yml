name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  lint:
    name: Lint & Syntax Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install ESLint
        run: npm install eslint @eslint/js --save-dev

      - name: Create ESLint config
        run: |
          cat > eslint.config.mjs << 'EOF'
          export default [
            {
              files: ["**/*.gs"],
              languageOptions: {
                ecmaVersion: 2020,
                sourceType: "script",
                globals: {
                  // Google Apps Script globals
                  SpreadsheetApp: "readonly",
                  PropertiesService: "readonly",
                  UrlFetchApp: "readonly",
                  HtmlService: "readonly",
                  Utilities: "readonly",
                  Logger: "readonly",
                  console: "readonly",
                }
              },
              rules: {
                // Only check for common syntax issues
                "no-undef": "off",  // GAS has cross-file globals
                "no-unused-vars": "off",  // GAS functions are called by triggers/menus
                "semi": ["error", "always"],
                "no-extra-semi": "error",
                "no-unreachable": "error",
                "no-dupe-keys": "error",
                "no-duplicate-case": "error",
                "no-empty": ["error", { "allowEmptyCatch": true }],
                "no-irregular-whitespace": "error",
                "valid-typeof": "error",
              }
            },
          ];
          EOF

      - name: Run ESLint
        run: npx eslint "*.gs" --max-warnings 0

  push:
    name: Push to Apps Script
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install clasp
        run: npm install -g @google/clasp

      - name: Generate .clasp.json
        env:
          SCRIPT_ID: ${{ secrets.SCRIPT_ID }}
        run: |
          if [ -n "$SCRIPT_ID" ]; then
            echo "{\"scriptId\":\"$SCRIPT_ID\",\"rootDir\":\".\"}" > .clasp.json
            echo "Generated .clasp.json"
          else
            echo "::error::SCRIPT_ID secret not configured - cannot push to Apps Script"
            exit 1
          fi

      - name: Inject spreadsheet ID
        env:
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
        run: |
          if [ -n "$SPREADSHEET_ID" ]; then
            sed -i "s/YOUR_SPREADSHEET_ID_HERE/$SPREADSHEET_ID/g" spreadsheet.gs
            echo "Injected SPREADSHEET_ID into spreadsheet.gs"
          else
            echo "Warning: SPREADSHEET_ID secret not configured - web app mode will not work"
          fi

      - name: Push to Apps Script (HEAD)
        env:
          CLASP_TOKEN: ${{ secrets.CLASP_TOKEN }}
        run: |
          if [ -n "$CLASP_TOKEN" ]; then
            echo "$CLASP_TOKEN" > ~/.clasprc.json
            clasp push -f
            echo "Pushed to Apps Script (HEAD)"
          else
            echo "CLASP_TOKEN secret not configured - skipping push"
            echo "To enable, add your ~/.clasprc.json contents as a repository secret named CLASP_TOKEN"
          fi

      - name: Show /dev test URL
        if: github.event_name == 'pull_request'
        run: |
          echo "::notice::Test your changes at the /dev URL: https://script.google.com/macros/s/${{ secrets.SCRIPT_ID }}/dev"

  deploy:
    name: Deploy Production
    runs-on: ubuntu-latest
    needs: push
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install clasp
        run: npm install -g @google/clasp

      - name: Deploy to production
        env:
          CLASP_TOKEN: ${{ secrets.CLASP_TOKEN }}
          SCRIPT_ID: ${{ secrets.SCRIPT_ID }}
          DEPLOYMENT_ID: ${{ secrets.DEPLOYMENT_ID }}
        run: |
          if [ -z "$CLASP_TOKEN" ]; then
            echo "CLASP_TOKEN secret not configured - skipping deploy"
            exit 0
          fi
          if [ -z "$DEPLOYMENT_ID" ]; then
            echo "::warning::DEPLOYMENT_ID secret not configured - skipping production deploy"
            echo "Push to HEAD succeeded, but production /exec URL was NOT updated."
            echo "Add DEPLOYMENT_ID secret to enable production deploys on merge to master."
            exit 0
          fi
          echo "$CLASP_TOKEN" > ~/.clasprc.json
          echo "{\"scriptId\":\"$SCRIPT_ID\",\"rootDir\":\".\"}" > .clasp.json
          clasp deploy --deploymentId "$DEPLOYMENT_ID" -d "CI deploy $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "Deployed to production"
          echo "::notice::Production /exec URL updated"
