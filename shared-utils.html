<script>
  /* ============================================
     Shared UI Utilities
     Included via <?!= include('shared-utils') ?>
     ============================================ */

  /**
   * Shows a toast notification.
   * Requires a #toastContainer element and toast CSS from design-tokens.html.
   * Each file provides its own toast-container position override.
   *
   * @param {string} message - Text to display
   * @param {string} [type='success'] - 'success', 'error', or 'warning'
   */
  function showToast(message, type) {
    var container = document.getElementById('toastContainer');
    while (container.firstChild) container.removeChild(container.firstChild);

    var toast = document.createElement('div');
    toast.className = 'toast toast-' + (type || 'success');

    // SVG icon paths
    var paths = {
      success: 'M5 13l4 4L19 7',
      error: 'M6 18L18 6M6 6l12 12',
      warning: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4.5c-.77-.833-2.694-.833-3.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z'
    };

    var iconSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    iconSvg.setAttribute('fill', 'none');
    iconSvg.setAttribute('viewBox', '0 0 24 24');
    iconSvg.setAttribute('stroke', 'currentColor');
    var iconPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    iconPath.setAttribute('stroke-linecap', 'round');
    iconPath.setAttribute('stroke-linejoin', 'round');
    iconPath.setAttribute('stroke-width', '2');
    iconPath.setAttribute('d', paths[type] || paths.success);
    iconSvg.appendChild(iconPath);
    toast.appendChild(iconSvg);

    var textSpan = document.createElement('span');
    textSpan.textContent = message;
    toast.appendChild(textSpan);

    var isError = (type === 'error');

    // Error toasts get a close button and persist until dismissed
    if (isError) {
      var closeBtn = document.createElement('button');
      closeBtn.className = 'toast-close-btn';
      closeBtn.setAttribute('aria-label', 'Dismiss');
      closeBtn.innerHTML = '<svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
      closeBtn.onclick = function() {
        toast.classList.add('toast-out');
        setTimeout(function() {
          if (toast.parentNode) toast.parentNode.removeChild(toast);
        }, 250);
      };
      toast.appendChild(closeBtn);
    }

    // Add timer bar (not for persistent error toasts)
    if (!isError) {
      var timerBar = document.createElement('div');
      timerBar.className = 'toast-timer';
      toast.style.position = 'relative';
      toast.appendChild(timerBar);
    }

    container.appendChild(toast);

    // Auto-dismiss success/warning after 5s; errors persist
    if (!isError) {
      setTimeout(function() {
        toast.classList.add('toast-out');
        setTimeout(function() {
          if (toast.parentNode) toast.parentNode.removeChild(toast);
        }, 250);
      }, 5000);
    }
  }

  /**
   * Shows a toast with an "Undo" button and an extended 8-second dismiss timer.
   * Used for reversible actions like payment status changes.
   *
   * @param {string} message - Text to display
   * @param {Function} onUndo - Callback invoked when the user clicks Undo
   */
  function showUndoToast(message, onUndo) {
    var container = document.getElementById('toastContainer');
    while (container.firstChild) container.removeChild(container.firstChild);

    var toast = document.createElement('div');
    toast.className = 'toast toast-success';

    var iconSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    iconSvg.setAttribute('fill', 'none');
    iconSvg.setAttribute('viewBox', '0 0 24 24');
    iconSvg.setAttribute('stroke', 'currentColor');
    var iconPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    iconPath.setAttribute('stroke-linecap', 'round');
    iconPath.setAttribute('stroke-linejoin', 'round');
    iconPath.setAttribute('stroke-width', '2');
    iconPath.setAttribute('d', 'M5 13l4 4L19 7');
    iconSvg.appendChild(iconPath);
    toast.appendChild(iconSvg);

    var textSpan = document.createElement('span');
    textSpan.textContent = message;
    toast.appendChild(textSpan);

    var undoBtn = document.createElement('button');
    undoBtn.className = 'toast-undo-btn';
    undoBtn.textContent = 'Undo';
    undoBtn.onclick = function() {
      clearTimeout(dismissTimer);
      if (toast.parentNode) toast.parentNode.removeChild(toast);
      if (onUndo) onUndo();
    };
    toast.appendChild(undoBtn);

    var timerBar = document.createElement('div');
    timerBar.className = 'toast-timer toast-timer-slow';
    toast.style.position = 'relative';
    toast.appendChild(timerBar);

    container.appendChild(toast);

    var dismissTimer = setTimeout(function() {
      toast.classList.add('toast-out');
      setTimeout(function() {
        if (toast.parentNode) toast.parentNode.removeChild(toast);
      }, 250);
    }, 8000);
  }

  /**
   * Shows a confirm dialog. Returns a Promise that resolves to true (confirm) or false (cancel).
   * Requires #confirmDialog overlay with #confirmDialogTitle, #confirmDialogMessage,
   * #confirmDialogConfirm, and #confirmDialogCancel elements. CSS from design-tokens.html.
   *
   * @param {Object} opts
   * @param {string} [opts.title='Confirm']
   * @param {string} [opts.message='Are you sure?']
   * @param {string} [opts.confirmLabel='Confirm']
   * @param {string} [opts.cancelLabel='Cancel']
   * @param {boolean} [opts.destructive=false]
   * @returns {Promise<boolean>}
   */
  function showConfirm(opts) {
    var title = opts.title || 'Confirm';
    var message = opts.message || 'Are you sure?';
    var confirmLabel = opts.confirmLabel || 'Confirm';
    var cancelLabel = opts.cancelLabel || 'Cancel';
    var destructive = opts.destructive || false;

    var overlay = document.getElementById('confirmDialog');
    var titleEl = document.getElementById('confirmDialogTitle');
    var messageEl = document.getElementById('confirmDialogMessage');
    var confirmBtn = document.getElementById('confirmDialogConfirm');
    var cancelBtn = document.getElementById('confirmDialogCancel');

    titleEl.textContent = title;
    messageEl.textContent = message;
    confirmBtn.textContent = confirmLabel;
    cancelBtn.textContent = cancelLabel;

    confirmBtn.className = destructive ? 'btn btn-destructive' : 'btn btn-primary';

    overlay.classList.add('visible');
    confirmBtn.focus();

    return new Promise(function(resolve) {
      function cleanup() {
        overlay.classList.remove('visible');
        confirmBtn.removeEventListener('click', onConfirm);
        cancelBtn.removeEventListener('click', onCancel);
        document.removeEventListener('keydown', onKey);
        overlay.removeEventListener('click', onBackdrop);
      }
      function onConfirm() { cleanup(); resolve(true); }
      function onCancel() { cleanup(); resolve(false); }
      function onKey(e) {
        if (e.key === 'Escape') { e.stopPropagation(); onCancel(); }
      }
      function onBackdrop(e) {
        if (e.target === overlay) onCancel();
      }
      confirmBtn.addEventListener('click', onConfirm);
      cancelBtn.addEventListener('click', onCancel);
      document.addEventListener('keydown', onKey);
      overlay.addEventListener('click', onBackdrop);
    });
  }
</script>
