<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <?!= include('design-tokens') ?>
  <style>
  <?!= include('webapp-styles') ?>
  </style>
</head>
<body>
  <a href="#mainContent" class="skip-link">Skip to content</a>
  <div class="app-layout">
    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="appSidebar">
      <div class="sidebar-brand">
        <div class="sidebar-brand-icon">
          <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <span class="sidebar-brand-text">Ilaxi Billing</span>
      </div>

      <nav class="sidebar-nav" role="tablist" aria-label="Main navigation">
        <button class="tab sidebar-nav-item active" data-tab="dashboard" role="tab" aria-selected="true" aria-controls="panel-dashboard" tabindex="0" onclick="switchTab('dashboard')">
          <svg class="tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
          <span class="sidebar-nav-label">Dashboard</span>
        </button>
        <button class="tab sidebar-nav-item" data-tab="messages" role="tab" aria-selected="false" aria-controls="panel-messages" tabindex="-1" onclick="switchTab('messages')">
          <svg class="tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
          <span class="sidebar-nav-label">Messages</span>
        </button>
        <button class="tab sidebar-nav-item" data-tab="settings" role="tab" aria-selected="false" aria-controls="panel-settings" tabindex="-1" onclick="switchTab('settings')">
          <svg class="tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
          <span class="sidebar-nav-label">Settings</span>
        </button>
      </nav>

      <div class="sidebar-status">
        <div class="header-status-pills" id="headerStatusPills"></div>
      </div>

      <div class="sidebar-footer">
        <span class="header-users" id="headerUsers" title="Authorized users"></span>
        <button class="sidebar-theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode" aria-label="Toggle dark/light mode">
          <span class="theme-toggle-icon">
            <svg class="icon-moon" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
            <svg class="icon-sun" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
          </span>
        </button>
      </div>
    </aside>

    <!-- Mobile sidebar overlay -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Main Area -->
    <div class="main-area">
      <header class="topbar">
        <button class="sidebar-toggle-btn" onclick="toggleSidebar()" title="Toggle sidebar" aria-label="Toggle sidebar">
          <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
        <h1 class="topbar-title" id="topbarTitle">Dashboard</h1>
        <div class="topbar-actions">
          <!-- Spacer to push content right -->
        </div>
      </header>

      <main class="content" id="mainContent">
    <!-- Dashboard Tab -->
    <div class="tab-panel active" id="panel-dashboard" role="tabpanel" aria-labelledby="tab-dashboard">
      <div class="tab-intro">
        <div class="tab-intro-title">Dashboard</div>
        <div class="tab-intro-desc">Your billing overview at a glance. Track payments, send reminders, and manage customers.</div>
      </div>

      <!-- Setup Checklist (hidden when all done) -->
      <div class="setup-checklist" id="setupChecklist" style="display: none;">
        <div class="setup-checklist-header">
          <div class="setup-checklist-title">Get Started</div>
          <div class="setup-checklist-subtitle">Complete these steps to start sending bills</div>
          <div class="setup-checklist-progress">
            <div class="setup-checklist-fill" id="setupProgressFill" style="width: 0%;"></div>
          </div>
        </div>
        <div class="setup-checklist-items">
          <div class="setup-check-item" id="setupCredentials" onclick="openCredentialsModal()">
            <div class="setup-check-dot" id="setupCredentialsDot">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
            </div>
            <div class="setup-check-label">Set up Twilio credentials<small>Connect your SMS provider to send messages</small></div>
            <span class="setup-check-action">Configure</span>
          </div>
          <div class="setup-check-item" id="setupBusiness" onclick="switchTab('settings'); setTimeout(function(){ switchSettingsTab('business'); }, 100);">
            <div class="setup-check-dot" id="setupBusinessDot">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
            </div>
            <div class="setup-check-label">Add business details<small>Your name and payment info appear in every message</small></div>
            <span class="setup-check-action">Set up</span>
          </div>
          <div class="setup-check-item" id="setupColumns" onclick="switchTab('settings'); setTimeout(function(){ switchSettingsTab('spreadsheet'); }, 100);">
            <div class="setup-check-dot" id="setupColumnsDot">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
            </div>
            <div class="setup-check-label">Map spreadsheet columns<small>Tell the app where to find customer data</small></div>
            <span class="setup-check-action">Map columns</span>
          </div>
          <div class="setup-check-item" id="setupTemplates" onclick="switchTab('messages')">
            <div class="setup-check-dot" id="setupTemplatesDot">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
            </div>
            <div class="setup-check-label">Customize message templates<small>Personalize the messages sent to customers</small></div>
            <span class="setup-check-action">Edit templates</span>
          </div>
        </div>
      </div>

      <!-- Hero Stats ‚Äî 3 horizontal cards -->
      <div class="hero-stats" id="statsGrid" aria-live="polite">
        <div class="hero-stat hero-stat--outstanding hero-stat--loading">
          <div class="hero-stat-top">
            <div class="hero-stat-info">
              <span class="hero-stat-label">Outstanding</span>
              <span class="hero-stat-value" id="statBalance">$0.00</span>
            </div>
            <div class="hero-stat-icon">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </div>
          </div>
          <button class="hero-stat-cta" onclick="openSendBar()">
            Collect Payment
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
          </button>
        </div>

        <div class="hero-stat hero-stat--unpaid hero-stat--loading">
          <div class="hero-stat-top">
            <div class="hero-stat-info">
              <span class="hero-stat-label">Unpaid</span>
              <span class="hero-stat-value" id="statUnpaid">0</span>
            </div>
            <div class="hero-stat-icon">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </div>
          </div>
          <button class="hero-stat-cta" onclick="openSendBar()">
            Send Reminders
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
          </button>
        </div>

        <div class="hero-stat hero-stat--paid hero-stat--loading">
          <div class="hero-stat-top">
            <div class="hero-stat-info">
              <span class="hero-stat-label">Paid</span>
              <span class="hero-stat-value" id="statPaid">0</span>
            </div>
            <div class="hero-stat-icon">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </div>
          </div>
          <span class="hero-stat-detail" id="statTotal">Total customers: -</span>
        </div>
      </div>

      <!-- Column Mapping Warning Banner -->
      <div class="callout callout-warn" id="columnWarningBanner" style="display: none;">
        <svg class="callout-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
        <div class="callout-content">
          <strong id="colWarningTitle"></strong>
          <span id="colWarningDesc"></span>
        </div>
      </div>

      <!-- Duplicate Detection Banner -->
      <div class="callout callout-warn" id="duplicateBanner" style="display: none;">
        <svg class="callout-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
        <div class="callout-content">
          <strong id="dupBannerTitle"></strong>
          <span id="dupBannerDesc"></span>
          <button class="btn btn-ghost btn-xs" onclick="filterByDuplicates()" style="margin-top: var(--space-1);">Show Duplicates</button>
        </div>
      </div>

      <!-- Send Action Bar (collapsible) -->
      <div class="send-action-bar" id="sendActionBar" aria-expanded="false">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <svg class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width:18px;height:18px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
              Send Bills
            </h2>
            <button class="btn-close-bar" onclick="closeSendBar()" title="Close">
              <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
          <div class="card-body">
            <div id="sendAlert"></div>

            <div class="send-form-grid">
              <div class="form-group">
                <label for="sendFilter">Recipients</label>
                <select id="sendFilter" onchange="toggleDateInput(); updateRecipientCount();">
                  <option value="unpaid">All Unpaid Customers</option>
                  <option value="byDate">Unpaid by Due Date</option>
                </select>
              </div>
              <div class="form-group" id="dueDateGroup" style="display: none;">
                <label for="dueDate">Due Date / Month</label>
                <input type="text" id="dueDate" placeholder="e.g., October or 2024-10-31" oninput="updateRecipientCount();">
              </div>
              <div class="form-group">
                <label for="templateType">Template</label>
                <select id="templateType">
                  <option value="firstNotice">First Notice</option>
                  <option value="followUp">Follow-up Reminder</option>
                  <option value="finalNotice">Final Notice</option>
                </select>
              </div>
            </div>

            <div id="recipientPreview" style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-top: var(--space-2); margin-bottom: var(--space-4);"></div>

            <div id="dryRunWarning" class="callout callout-warn" style="display: none;">
              <svg class="callout-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
              <div class="callout-content"><strong>Dry Run Mode is ON.</strong> No real messages will be sent. Status column will show "[DRY RUN]" results.</div>
            </div>

            <button class="btn btn-primary" id="sendBillsBtn" onclick="sendBills()" style="padding: var(--space-3) var(--space-6);">
              <svg class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
              Send Bills
            </button>
            <div class="send-progress-bar" id="sendProgressBar">
              <div class="send-progress-bar-inner"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Customers Table Card -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Customers</h2>
          <div style="display:flex; gap:var(--space-2); align-items:center;">
            <a class="btn btn-ghost btn-sm" id="openSpreadsheetAction" href="#" target="_blank" style="text-decoration:none;">
              <svg class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
              Spreadsheet
            </a>
            <button class="btn btn-secondary btn-sm" onclick="refreshCustomers()">
              <svg class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
              Refresh
            </button>
          </div>
        </div>
        <div class="filter-bar" id="customerFilters">
          <div class="filter-group">
            <label class="filter-label">Payment</label>
            <select class="filter-select" id="filterPayment" onchange="applyCustomerFilters()">
              <option value="">All</option>
              <option value="paid">Paid</option>
              <option value="unpaid">Unpaid</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Notice</label>
            <select class="filter-select" id="filterNotice" onchange="applyCustomerFilters()">
              <option value="">All</option>
              <option value="first">First Notice</option>
              <option value="followup">Follow-up</option>
              <option value="final">Final Notice</option>
              <option value="thankyou">Thank You</option>
              <option value="error">Error</option>
              <option value="none">Not Sent</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Balance</label>
            <div style="display:flex; gap:var(--space-1); align-items:center;">
              <input type="number" class="filter-input" id="filterBalanceMin" placeholder="Min" oninput="applyCustomerFilters()">
              <span style="color:var(--color-text-muted); font-size: var(--text-xs);">to</span>
              <input type="number" class="filter-input" id="filterBalanceMax" placeholder="Max" oninput="applyCustomerFilters()">
            </div>
          </div>
          <div class="filter-group">
            <label class="filter-label">Duplicates</label>
            <select class="filter-select" id="filterDuplicates" onchange="applyCustomerFilters()">
              <option value="">All</option>
              <option value="exact">Exact Duplicates</option>
              <option value="related">Multi-period</option>
              <option value="any">Any Duplicate</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Search</label>
            <input type="text" class="filter-search" id="filterSearch" placeholder="Name, phone, order..." oninput="applyCustomerFilters()">
          </div>
          <div style="margin-left:auto; display:flex; align-items:center; gap:var(--space-2);">
            <span class="filter-count" id="filterCount"></span>
            <button class="btn btn-ghost btn-xs" onclick="clearCustomerFilters()">Clear</button>
          </div>
        </div>
        <div class="card-body" style="padding: 0;">
          <div class="table-container table-scroll-fade" id="customersTable" aria-live="polite">
            <div class="loading"><div class="spinner"></div>Loading customers...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Messages Tab -->
    <div class="tab-panel" id="panel-messages" role="tabpanel" aria-labelledby="tab-messages">
      <div class="messages-page">
        <!-- Page Header -->
        <div class="messages-header">
          <div class="messages-header-content">
            <h1 class="messages-title">Message Templates</h1>
            <p class="messages-subtitle">Create and customize the messages sent to your customers. Each template serves a different purpose in your billing workflow.</p>
          </div>
          <div class="messages-header-status">
            <span class="template-save-status" id="globalTemplateStatus"></span>
          </div>
        </div>

        <!-- Template Cards Grid -->
        <div class="template-cards-grid">
          <button class="template-card active" data-template="firstNotice" onclick="selectTemplateCard('firstNotice')">
            <div class="template-card-icon first-notice">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            </div>
            <div class="template-card-content">
              <span class="template-card-title">First Notice</span>
              <span class="template-card-desc">Initial billing reminder</span>
            </div>
            <div class="template-card-check">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
            </div>
          </button>

          <button class="template-card" data-template="followUp" onclick="selectTemplateCard('followUp')">
            <div class="template-card-icon follow-up">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </div>
            <div class="template-card-content">
              <span class="template-card-title">Follow-up</span>
              <span class="template-card-desc">Gentle payment reminder</span>
            </div>
            <div class="template-card-check">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
            </div>
          </button>

          <button class="template-card" data-template="finalNotice" onclick="selectTemplateCard('finalNotice')">
            <div class="template-card-icon final-notice">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
            </div>
            <div class="template-card-content">
              <span class="template-card-title">Final Notice</span>
              <span class="template-card-desc">Urgent overdue alert</span>
            </div>
            <div class="template-card-check">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
            </div>
          </button>

          <button class="template-card" data-template="thankYou" onclick="selectTemplateCard('thankYou')">
            <div class="template-card-icon thank-you">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
            </div>
            <div class="template-card-content">
              <span class="template-card-title">Thank You</span>
              <span class="template-card-desc">Payment confirmation</span>
            </div>
            <div class="template-card-check">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
            </div>
          </button>
        </div>

        <!-- Alert Container -->
        <div id="messagesTabAlert" class="messages-alert-container"></div>

        <!-- Main Editor Area -->
        <div class="message-editor-container">
          <!-- Editor Side -->
          <div class="message-editor-main">
            <div class="editor-section">
              <label class="editor-label">Template Name</label>
              <p class="editor-hint">A friendly name to identify this template</p>
              <input type="text" id="msgTemplateName" class="editor-input" placeholder="e.g., First Payment Reminder">
            </div>

            <div class="editor-section editor-section-grow">
              <div class="editor-label-row">
                <label class="editor-label">Message Content</label>
                <span class="sms-segment-info" id="msgSegmentInfo">0 chars ¬∑ 0 segments</span>
                <span class="editor-char-count" id="msgCharCounter">0 / 1600</span>
              </div>
              <p class="editor-hint">Write your message below. Click the tags to insert personalization.</p>
              <textarea id="msgTemplateContent" class="editor-textarea" placeholder="Hi {{customerName}},&#10;&#10;This is a reminder that your payment of {{balance}} is due.&#10;&#10;Please send an e-transfer to {{etransferEmail}}.&#10;&#10;Thank you!&#10;{{businessName}}" oninput="updateMsgCharCount(); updateMsgPreview();"></textarea>
              <div class="editor-char-bar">
                <div class="editor-char-fill" id="msgCharFill"></div>
              </div>
            </div>

            <!-- Placeholders -->
            <div class="editor-section">
              <label class="editor-label">Personalization Tags</label>
              <p class="editor-hint">Click a tag to insert it at the cursor position</p>
              <div class="placeholder-tags">
                <button type="button" class="placeholder-tag" onclick="insertMsgPlaceholder('customerName')" data-tooltip="Customer's name">
                  <span class="tag-icon">üë§</span> customerName
                </button>
                <button type="button" class="placeholder-tag" onclick="insertMsgPlaceholder('balance')" data-tooltip="Amount owed">
                  <span class="tag-icon">üí∞</span> balance
                </button>
                <button type="button" class="placeholder-tag" onclick="insertMsgPlaceholder('numTiffins')" data-tooltip="Number of tiffins">
                  <span class="tag-icon">üç±</span> numTiffins
                </button>
                <button type="button" class="placeholder-tag" onclick="insertMsgPlaceholder('month')" data-tooltip="Billing month">
                  <span class="tag-icon">üìÖ</span> month
                </button>
                <button type="button" class="placeholder-tag" onclick="insertMsgPlaceholder('businessName')" data-tooltip="Your business name">
                  <span class="tag-icon">üè¢</span> businessName
                </button>
                <button type="button" class="placeholder-tag" onclick="insertMsgPlaceholder('etransferEmail')" data-tooltip="Payment email">
                  <span class="tag-icon">üìß</span> etransferEmail
                </button>
                <button type="button" class="placeholder-tag" onclick="insertMsgPlaceholder('phoneNumber')" data-tooltip="Your phone number">
                  <span class="tag-icon">üì±</span> phoneNumber
                </button>
                <button type="button" class="placeholder-tag" onclick="insertMsgPlaceholder('orderId')" data-tooltip="Order ID">
                  <span class="tag-icon">üî¢</span> orderId
                </button>
              </div>
            </div>

            <!-- Save Button -->
            <div class="editor-actions">
              <button class="btn btn-primary btn-save-template" id="msgSaveBtn" onclick="saveMsgTemplate()">
                <svg class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                Save Template
              </button>
            </div>
          </div>

          <!-- Preview Side -->
          <div class="message-preview-side">
            <div class="preview-device">
              <div class="preview-device-header">
                <div class="preview-device-title">
                  <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
                  Live Preview
                </div>
                <div style="display: flex; align-items: center; gap: 6px;">
                  <span class="preview-sample-badge">Sample Data</span>
                  <button class="btn-expand-preview" onclick="openFullscreenPreview()" title="View fullscreen">
                    <svg width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
                    Expand
                  </button>
                </div>
              </div>
              <div class="preview-device-screen">
                <div class="preview-conversation">
                  <div class="preview-sms-bubble" id="msgPreviewBubble">
                    <p class="preview-empty-state">Start typing to see your message preview...</p>
                  </div>
                  <div class="preview-sms-meta">
                    <span>SMS</span>
                    <span>¬∑</span>
                    <span id="msgPreviewTime">Just now</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="preview-info-card">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <div>
                <strong>Preview uses sample data</strong>
                <p>Actual messages will use real customer information from your spreadsheet.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- Settings Tab -->
    <div class="tab-panel" id="panel-settings" role="tabpanel" aria-labelledby="tab-settings">
      <div class="settings-layout">
        <!-- Settings Navigation Sidebar -->
        <nav class="settings-nav" role="navigation" aria-label="Settings sections">
          <div class="settings-nav-header">
            <span class="settings-nav-title">Settings</span>
            <button class="settings-nav-toggle" onclick="toggleSettingsNav()" title="Collapse sidebar" aria-label="Toggle sidebar">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/></svg>
            </button>
          </div>
          <div class="settings-nav-items">
            <button class="settings-nav-item active" data-settings-tab="business" data-tooltip="My Business" onclick="switchSettingsTab('business')">
              <svg class="settings-nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
              <span class="settings-nav-label">My Business</span>
            </button>
            <button class="settings-nav-item" data-settings-tab="spreadsheet" data-tooltip="Spreadsheet" onclick="switchSettingsTab('spreadsheet')">
              <svg class="settings-nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
              <span class="settings-nav-label">Spreadsheet</span>
            </button>
            <button class="settings-nav-item" data-settings-tab="advanced" data-tooltip="Advanced" onclick="switchSettingsTab('advanced')">
              <svg class="settings-nav-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>
              <span class="settings-nav-label">Advanced</span>
            </button>
          </div>
          <div class="settings-nav-footer">
            <div class="settings-nav-footer-title">Manage</div>
            <div class="settings-nav-footer-actions">
              <button class="btn btn-ghost btn-sm" onclick="exportSettingsUI()" title="Export settings as JSON">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                <span>Export</span>
              </button>
              <button class="btn btn-ghost btn-sm" onclick="importSettingsUI()" title="Import settings from JSON file">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                <span>Import</span>
              </button>
              <button class="btn btn-ghost btn-danger-ghost btn-sm" onclick="confirmResetSettings()" title="Reset all settings to defaults">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                <span>Reset All</span>
              </button>
            </div>
          </div>
        </nav>

        <!-- Settings Content Area -->
        <div class="settings-content">
          <!-- My Business Panel -->
          <div class="settings-panel active" id="settings-business">
            <div class="settings-section-header">
              <h2 class="settings-section-title">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                My Business
              </h2>
              <p class="settings-section-desc">Fill in your business details below. This information appears in every billing message sent to your customers.</p>
            </div>

            <div id="settingsAlert"></div>

            <div class="form-field">
              <label class="form-field-label">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5"/></svg>
                Business Name
              </label>
              <p class="form-field-desc">The name that appears in your billing messages</p>
              <input type="text" id="businessName" placeholder="e.g., Ilaxi Tiffin Service">
            </div>

            <div class="form-field">
              <label class="form-field-label">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                E-Transfer Email
              </label>
              <p class="form-field-desc">Where customers should send their payments</p>
              <input type="email" id="etransferEmail" placeholder="e.g., payments@yourbusiness.com">
            </div>

            <div class="form-field-row">
              <div class="form-field">
                <label class="form-field-label">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                  Phone Number
                </label>
                <p class="form-field-desc">Your contact number for customers</p>
                <input type="text" id="businessPhone" placeholder="e.g., +1 (416) 555-1234">
              </div>
              <div class="form-field">
                <label class="form-field-label">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z"/></svg>
                  WhatsApp Link
                </label>
                <p class="form-field-desc">Optional: Link to your WhatsApp</p>
                <input type="url" id="whatsappLink" placeholder="e.g., https://wa.me/14165551234">
              </div>
            </div>

            <div class="settings-actions">
              <span class="settings-actions-hint">Changes are saved when you click the button</span>
              <button class="btn btn-primary" id="saveBusinessBtn" onclick="saveSettings(this)">
                <svg class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                Save Changes
              </button>
            </div>
          </div>

          <!-- Spreadsheet Panel -->
          <div class="settings-panel" id="settings-spreadsheet">
            <div class="settings-section-header">
              <h2 class="settings-section-title">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                Spreadsheet Setup
              </h2>
              <p class="settings-section-desc">Tell the app which columns in your spreadsheet contain customer information.</p>
            </div>

            <div id="columnsAlert"></div>

            <div class="column-mapping-intro">
              <div class="column-mapping-intro-icon">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
              </div>
              <div class="column-mapping-intro-content">
                <h4>Quick Setup</h4>
                <p>Click the <strong>Auto-Detect</strong> button and the app will try to match your spreadsheet columns automatically. You can then review and adjust as needed.</p>
              </div>
            </div>

            <div style="display: flex; justify-content: flex-end; margin-bottom: var(--space-4);">
              <button class="btn btn-primary" onclick="autoDetectColumns()">
                <svg class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                Auto-Detect Columns
              </button>
            </div>

            <div id="columnCompleteness" class="column-completeness" style="display:none;">
              <span class="column-completeness-label" id="columnCompletenessLabel">0 of 8 mapped</span>
              <div class="column-completeness-bar">
                <div class="column-completeness-fill" id="columnCompletenessFill" style="width:0%;"></div>
              </div>
            </div>

            <div id="columnMappingStatus" class="column-mapping-status" style="display: none;">
              <div class="spinner"></div>
              <span>Analyzing your spreadsheet...</span>
            </div>

            <div class="column-mapping-grid" id="columnMappingGrid">
              <div class="column-mapping-item" id="mappingPhoneNumber">
                <div class="column-mapping-header">
                  <div class="column-mapping-label">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                    Phone Number
                  </div>
                  <span class="column-detect-badge" id="badgePhoneNumber"></span>
                </div>
                <div class="column-select-wrapper">
                  <select class="column-select" id="colPhoneNumber" data-column="phoneNumber"></select>
                </div>
              </div>

              <div class="column-mapping-item" id="mappingCustomerName">
                <div class="column-mapping-header">
                  <div class="column-mapping-label">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                    Customer Name
                  </div>
                  <span class="column-detect-badge" id="badgeCustomerName"></span>
                </div>
                <div class="column-select-wrapper">
                  <select class="column-select" id="colCustomerName" data-column="customerName"></select>
                </div>
              </div>

              <div class="column-mapping-item" id="mappingBalance">
                <div class="column-mapping-header">
                  <div class="column-mapping-label">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    Balance Owed
                  </div>
                  <span class="column-detect-badge" id="badgeBalance"></span>
                </div>
                <div class="column-select-wrapper">
                  <select class="column-select" id="colBalance" data-column="balance"></select>
                </div>
              </div>

              <div class="column-mapping-item" id="mappingNumTiffins">
                <div class="column-mapping-header">
                  <div class="column-mapping-label">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/></svg>
                    Number of Tiffins
                  </div>
                  <span class="column-detect-badge" id="badgeNumTiffins"></span>
                </div>
                <div class="column-select-wrapper">
                  <select class="column-select" id="colNumTiffins" data-column="numTiffins"></select>
                </div>
              </div>

              <div class="column-mapping-item" id="mappingDueDate">
                <div class="column-mapping-header">
                  <div class="column-mapping-label">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    Due Date / Month
                  </div>
                  <span class="column-detect-badge" id="badgeDueDate"></span>
                </div>
                <div class="column-select-wrapper">
                  <select class="column-select" id="colDueDate" data-column="dueDate"></select>
                </div>
              </div>

              <div class="column-mapping-item" id="mappingMessageStatus">
                <div class="column-mapping-header">
                  <div class="column-mapping-label">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
                    Message Status
                  </div>
                  <span class="column-detect-badge" id="badgeMessageStatus"></span>
                </div>
                <div class="column-select-wrapper">
                  <select class="column-select" id="colMessageStatus" data-column="messageStatus"></select>
                </div>
              </div>

              <div class="column-mapping-item" id="mappingOrderId">
                <div class="column-mapping-header">
                  <div class="column-mapping-label">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    Order ID
                  </div>
                  <span class="column-detect-badge" id="badgeOrderId"></span>
                </div>
                <div class="column-select-wrapper">
                  <select class="column-select" id="colOrderId" data-column="orderId"></select>
                </div>
              </div>

              <div class="column-mapping-item" id="mappingPaymentStatus">
                <div class="column-mapping-header">
                  <div class="column-mapping-label">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    Payment Status
                  </div>
                  <span class="column-detect-badge" id="badgePaymentStatus"></span>
                </div>
                <div class="column-select-wrapper">
                  <select class="column-select" id="colPaymentStatus" data-column="paymentStatus"></select>
                </div>
              </div>
            </div>

            <div class="settings-actions">
              <span class="settings-actions-hint">Match each field to a column in your spreadsheet</span>
              <button class="btn btn-primary" id="saveColumnsBtn" onclick="saveColumnMappings()">
                <svg class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                Save Column Mappings
              </button>
            </div>
          </div>

          <!-- Advanced Panel -->
          <div class="settings-panel" id="settings-advanced">
            <div class="settings-section-header" style="margin-bottom: var(--space-2);">
              <h2 class="settings-section-title">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>
                Advanced Options
              </h2>
              <p class="settings-section-desc">Technical settings for power users. Most users won't need to change these.</p>
            </div>

            <!-- Group 1: Configuration -->
            <div class="adv-group">
              <div class="adv-group-title">Configuration</div>

              <div class="adv-toggles">
                <div class="toggle-field">
                  <label class="toggle-switch">
                    <input type="checkbox" id="autoThankYouEnabled" checked onchange="if(currentSettings && currentSettings.behavior){ currentSettings.behavior.autoThankYouEnabled = this.checked; } updateHeaderStatusPills();">
                    <span class="toggle-slider"></span>
                  </label>
                  <div class="toggle-content">
                    <div class="toggle-label">Auto Thank-You Messages</div>
                    <p class="toggle-desc">Send a thank-you when payment is marked "Paid".</p>
                  </div>
                </div>

                <div class="toggle-field">
                  <label class="toggle-switch">
                    <input type="checkbox" id="dryRunCheckbox" onchange="updateSendReview();">
                    <span class="toggle-slider"></span>
                  </label>
                  <div class="toggle-content">
                    <div class="toggle-label">Dry Run Mode</div>
                    <p class="toggle-desc">Test without sending real SMS.</p>
                  </div>
                </div>
              </div>

              <div class="form-field-row">
                <div class="form-field" style="margin-bottom: var(--space-2);">
                  <label class="form-field-label">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                    Batch Size
                  </label>
                  <p class="form-field-desc">Max messages at once (1-200)</p>
                  <input type="number" id="batchSize" min="1" max="200" value="75">
                </div>

                <div class="form-field" style="margin-bottom: var(--space-2);">
                  <label class="form-field-label">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    Message Delay
                  </label>
                  <p class="form-field-desc">Wait time between messages (ms)</p>
                  <input type="number" id="messageDelay" min="500" max="5000" value="1000">
                </div>

                <div class="form-field" style="margin-bottom: var(--space-2);">
                  <label class="form-field-label">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
                    Header Row
                  </label>
                  <p class="form-field-desc">Row with column headers (usually 1)</p>
                  <input type="number" id="headerRow" min="1" value="1" style="max-width: 120px;">
                </div>

                <div class="form-field" style="margin-bottom: var(--space-2);">
                  <label class="form-field-label">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                    Test Customer Order ID
                  </label>
                  <p class="form-field-desc">Real customer data for previews.</p>
                  <input type="text" id="testOrderId" placeholder="e.g. ORD-2024-001">
                </div>
              </div>

              <div class="settings-actions" style="margin-top: var(--space-3);">
                <span class="settings-actions-hint">These settings apply to all billing operations</span>
                <button class="btn btn-primary" id="saveAdvancedBtn" onclick="saveSettings(this)">
                  <svg class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                  Save Advanced Settings
                </button>
              </div>
            </div>

            <!-- Group 2: Administration -->
            <div class="adv-group">
              <div class="adv-group-title">Administration</div>

              <!-- Twilio Credentials row -->
              <div class="adv-action-row">
                <span class="adv-action-label">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
                  Twilio Credentials
                </span>
                <span id="credStatusBadge" style="font-size: var(--text-xs); font-weight: 500; padding: 2px 8px; border-radius: var(--radius-full); background: var(--color-bg-tertiary); color: var(--color-text-secondary);">Checking...</span>
                <div class="adv-action-fill"></div>
                <button class="btn btn-secondary btn-sm" onclick="openCredentialsModal()">Manage</button>
              </div>

              <!-- Test Data row -->
              <div class="adv-action-row">
                <span class="adv-action-label">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                  Test Data for Previews
                </span>
                <span id="testDataBadge" style="font-size: var(--text-xs); font-weight: 500; padding: 2px 8px; border-radius: var(--radius-full); background: var(--color-bg-tertiary); color: var(--color-text-secondary);">Default</span>
                <div class="adv-action-fill"></div>
                <button class="btn btn-secondary btn-sm" onclick="openTestDataModal()">Manage</button>
              </div>

              <!-- User Access row -->
              <div class="adv-action-row" style="flex-wrap: wrap;">
                <span class="adv-action-label">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  Web App Access
                </span>
                <div class="adv-action-fill"></div>
                <div style="display: flex; gap: var(--space-2);">
                  <input type="email" id="newUserEmail" placeholder="user@gmail.com" style="width: 200px; padding: 4px var(--space-2); font-size: var(--text-xs); border: 1px solid var(--color-border); border-radius: var(--radius-md); outline: none;" onkeydown="if(event.key==='Enter'){addUser();}" onfocus="this.style.borderColor='var(--color-primary)'" onblur="this.style.borderColor='var(--color-border)'">
                  <button class="btn btn-secondary btn-sm" onclick="addUser()">Add</button>
                </div>
                <div id="usersList" class="users-manage-list" style="width: 100%; margin-top: var(--space-1);"></div>
              </div>

              <!-- Danger Zone row -->
              <div class="adv-action-row">
                <span class="adv-action-label">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                  Danger Zone
                </span>
                <div class="adv-action-fill"></div>
                <button class="btn btn-ghost btn-danger-ghost btn-sm" onclick="clearStatuses()">
                  <svg class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                  Clear All Statuses
                </button>
              </div>
            </div>

            <!-- Group 3: Activity Log -->
            <div class="adv-group">
              <div class="activity-log-section">
                <div class="log-filter-bar">
                  <label class="form-field-label" style="margin: 0;">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    Activity Log
                  </label>
                  <div style="display: flex; gap: var(--space-1); align-items: center; margin-left: auto;">
                    <select id="logCategoryFilter" class="column-select" style="width: auto; min-width: 100px; font-size: var(--text-xs); padding: 3px 6px;" onchange="applyLogCategoryFilter()">
                      <option value="all">All</option>
                      <option value="billing">Billing</option>
                      <option value="settings">Settings</option>
                      <option value="credentials">Credentials</option>
                      <option value="users">Users</option>
                      <option value="system">System</option>
                    </select>
                    <button class="btn btn-ghost btn-sm" onclick="loadActivityLog()" title="Refresh">
                      <svg class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width:14px;height:14px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                    </button>
                    <label style="display:flex;align-items:center;gap:4px;font-size:var(--text-xs);color:var(--color-text-secondary);cursor:pointer;" title="Auto-refresh every 30s">
                      <input type="checkbox" id="logAutoRefresh" onchange="toggleLogAutoRefresh()" style="margin:0;">
                      Auto
                    </label>
                    <button class="btn btn-ghost btn-sm" onclick="downloadActivityLog()" title="Download CSV" style="padding:3px 6px;">
                      <svg class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width:14px;height:14px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    </button>
                    <button class="btn btn-ghost btn-danger-ghost btn-sm" onclick="clearActivityLog()" title="Clear log" style="padding:3px 6px;">
                      <svg class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width:14px;height:14px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                  </div>
                </div>
                <div id="activityLogAlert"></div>
                <div id="activityLogLoading" style="display:none; text-align:center; padding: var(--space-3); color: var(--color-text-muted); font-size: var(--text-sm);">Loading activity log...</div>
                <div id="activityLogEmpty" class="empty-state" style="display:none; padding: var(--space-6) var(--space-4);">
                  <div class="empty-state-icon">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                  </div>
                  <div class="empty-state-title">No activity yet</div>
                  <div class="empty-state-desc">Actions like sending bills, saving settings, and managing users will appear here.</div>
                </div>
                <div id="activityLogTableWrap" style="display:none; max-height: 320px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: var(--radius-md);"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
    </div><!-- .main-area -->
  </div><!-- .app-layout -->

  <!-- Send Bill Modal -->
  <div class="modal-overlay" id="sendSingleModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Send Bill</h3>
        <button class="modal-close" onclick="closeSendModal()">
          <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      <div class="modal-body">
        <p><strong>Customer:</strong> <span id="modalCustomerName"></span></p>
        <p><strong>Balance:</strong> <span id="modalBalance"></span></p>
        <div class="form-group mt-4">
          <label for="modalTemplate">Template</label>
          <select id="modalTemplate">
            <option value="firstNotice">First Notice</option>
            <option value="followUp">Follow-up Reminder</option>
            <option value="finalNotice">Final Notice</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeSendModal()">Cancel</button>
        <button class="btn btn-primary" id="modalSendBtn" onclick="sendSingleBill()">Send Bill</button>
      </div>
    </div>
  </div>

  <!-- Credentials Modal -->
  <div class="modal-overlay" id="credentialsModal" onclick="if(event.target===this)closeCredentialsModal()">
    <div class="modal credentials-modal">
      <div class="modal-header">
        <h3>Twilio Credentials</h3>
        <button class="modal-close" onclick="closeCredentialsModal()">
          <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div id="credentialStatus" class="alert alert-info" style="display: none;" aria-live="polite"></div>
        <div id="credStatusLoading" style="font-size: var(--text-sm); color: var(--color-text-secondary);">Checking credentials...</div>
        <div id="credentialAlert"></div>
        <div class="form-group">
          <label for="accountSid">Account SID</label>
          <p style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-bottom: var(--space-2);">Starts with AC, found on your Twilio dashboard</p>
          <input type="text" id="accountSid" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" onblur="validateSidField()">
          <div class="field-error" id="sidError">Account SID must start with "AC"</div>
        </div>
        <div class="form-group">
          <label for="authToken">Auth Token</label>
          <p style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-bottom: var(--space-2);">Found under Account SID on your Twilio dashboard</p>
          <input type="password" id="authToken" placeholder="Enter your Auth Token">
        </div>
        <div class="form-group">
          <label for="twilioPhone">Twilio Phone Number</label>
          <p style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-bottom: var(--space-2);">Your Twilio phone number in +1XXXXXXXXXX format</p>
          <input type="text" id="twilioPhone" placeholder="+1XXXXXXXXXX" onblur="validatePhoneField()">
          <div class="field-error" id="phoneError">Phone number must start with "+" followed by digits</div>
        </div>
        <div id="connectionTestSteps" class="connection-test-steps" style="display:none;">
          <div class="step-item" id="testStep1"><span class="step-num">1</span> Connecting</div>
          <div class="step-connector"></div>
          <div class="step-item" id="testStep2"><span class="step-num">2</span> Authenticating</div>
          <div class="step-connector"></div>
          <div class="step-item" id="testStep3"><span class="step-num">3</span> Verified</div>
        </div>
      </div>
      <div class="modal-footer" style="justify-content: space-between;">
        <button class="btn btn-ghost btn-danger-ghost btn-sm" id="clearCredsBtn" onclick="clearCredentials()">Clear</button>
        <div style="display: flex; gap: var(--space-2);">
          <button class="btn btn-secondary" id="testConnectionBtn" onclick="testCredentials()">Test Connection</button>
          <button class="btn btn-primary" id="saveCredentialsBtn" onclick="saveCredentials()">Save Credentials</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Test Data Modal -->
  <div class="modal-overlay" id="testDataModal" onclick="if(event.target===this)closeTestDataModal()">
    <div class="modal credentials-modal">
      <div class="modal-header">
        <h3>Test Data for Previews</h3>
        <button class="modal-close" onclick="closeTestDataModal()">
          <svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <p style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-bottom: var(--space-4);">Customize the sample values used in message template previews. Leave fields empty to use defaults.</p>
        <div class="form-group">
          <label for="tdCustomerName">Customer Name</label>
          <input type="text" id="tdCustomerName" placeholder="John Doe">
        </div>
        <div class="form-group">
          <label for="tdBalance">Balance</label>
          <input type="text" id="tdBalance" placeholder="$150.00">
        </div>
        <div class="form-group">
          <label for="tdNumTiffins">No. of Tiffins</label>
          <input type="text" id="tdNumTiffins" placeholder="30">
        </div>
        <div class="form-group">
          <label for="tdMonth">Month</label>
          <input type="text" id="tdMonth" placeholder="January">
        </div>
        <div class="form-group">
          <label for="tdOrderId">Order ID</label>
          <input type="text" id="tdOrderId" placeholder="ORD-2024-001">
        </div>
      </div>
      <div class="modal-footer" style="justify-content: space-between;">
        <button class="btn btn-secondary btn-sm" onclick="autoPopulateTestData()">Auto-Populate</button>
        <div style="display: flex; gap: var(--space-2);">
          <button class="btn btn-ghost btn-sm" onclick="clearTestData()">Clear All</button>
          <button class="btn btn-primary" id="saveTestDataBtn" onclick="saveTestData()">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Fullscreen Preview Modal -->
  <div class="preview-fullscreen-modal" id="previewFullscreenModal" onclick="if(event.target===this)closeFullscreenPreview()">
    <div class="preview-fullscreen-inner">
      <div class="preview-fullscreen-header">
        <h3>Message Preview</h3>
        <button class="preview-fullscreen-close" onclick="closeFullscreenPreview()">
          <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="preview-fullscreen-body">
        <div class="preview-fullscreen-bubble" id="fullscreenPreviewContent">
          No preview available. Start typing a message template to see a preview.
        </div>
      </div>
      <div class="preview-fullscreen-meta">
        <span>SMS</span>
        <span>&middot;</span>
        <span>Sample Data</span>
      </div>
    </div>
  </div>

  <?!= include('webapp-core.js') ?>
  <?!= include('webapp-dashboard.js') ?>
  <?!= include('webapp-messages.js') ?>
  <?!= include('webapp-settings.js') ?>
  <div id="toastContainer" class="toast-container" role="status" aria-live="assertive"></div>
  <div class="modal-overlay" id="confirmDialog" role="alertdialog" aria-modal="true" aria-labelledby="confirmDialogTitle">
    <div class="modal confirm-modal">
      <div class="modal-header">
        <h3 class="modal-title" id="confirmDialogTitle"></h3>
      </div>
      <div class="modal-body">
        <p id="confirmDialogMessage"></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="confirmDialogCancel">Cancel</button>
        <button class="btn btn-primary" id="confirmDialogConfirm">Confirm</button>
      </div>
    </div>
  </div>
  <?!= include('shared-utils') ?>
</body>
</html>
